<!DOCTYPE html>
<html lang="sw" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Biashara Yako Automation</title>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CMBWJH2ER1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CMBWJH2ER1');
</script>

<!-- Amplitude Analytics Setup -->
<script src="https://cdn.amplitude.com/libs/amplitude-8.18.4-min.gz.js"></script>
<script>
  // Initialize Amplitude with your project API key
  const amp = amplitude.getInstance();
  amp.init("3ddef487e0f6c35a57bebd55e4c9b7e3");

  // Keep same user across sessions
  let userId = localStorage.getItem("user_id");
  if (!userId) {
    userId = "user_" + Math.random().toString(36).slice(2);
    localStorage.setItem("user_id", userId);
  }
  amp.setUserId(userId);

  // Track when user opens your app
  amp.logEvent("App Opened");

  // Track start time for session duration
  const sessionStart = Date.now();

  // Track session end when user leaves page
  window.addEventListener("beforeunload", function () {
    const durationSeconds = Math.floor((Date.now() - sessionStart) / 1000);
    amp.logEvent("Session Ended", { duration_seconds: durationSeconds });
  });
</script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Theme color -->
    <meta name="theme-color" content="#fafafa">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Linka">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/qR4TC1NW/IMG-20250518-122228.png">

    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <!-- Added Spline Sans for AI Page -->
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <!-- Added Playfair Display for Luxe look -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

<style>
    /* =========================================
       GLOBAL STYLES 
       ========================================= */
    :root {
        --primary: #25d078;
        --primary-dark: #1ea35e;
        
        /* LUXE THEME COLORS (From Image) */
        --luxe-blue: #0f172a; /* Dark Navy for Text */
        --luxe-accent-blue: #1d4ed8; /* Blue for buttons/prices */
        --luxe-banner-bg: #e0f2fe; /* Light Blue Banner */
        --luxe-bg: #ffffff;
        --luxe-gray: #f3f4f6;
        --luxe-text: #1f2937;
        
        --bg-body: #ffffff;
        --text-main: #1b140d;
        --text-muted: #6b7280;
        --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Plus Jakarta Sans', sans-serif; /* Updated to match the clean look */
        background-color: var(--bg-body); 
        color: var(--text-main);
        height: 100vh;
        overflow-x: hidden; 
    }

    /* Layout Structure */
    .screen-wrapper {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        overflow-y: auto; 
        position: relative;
        padding-bottom: 100px;
        background-color: white; 
    }

    /* FIXED: Mauzo Bottom Navigation Layout */
    #step-analytics.screen-wrapper, 
    #step-5.screen-wrapper {
        background-color: var(--bg-body);
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        height: 100vh;    
        padding-bottom: 0;
    }

    .content-area {
        padding: 20px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    /* Media Cards */
    .media-card {
        background: white;
        padding: 15px;
        border-radius: 24px;
        box-shadow: 0 8px 20px -5px rgba(0,0,0,0.08);
        margin: 20px 24px 10px 24px; 
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px solid #e5e7eb;
        max-width: 500px;
        align-self: center;
        width: calc(100% - 48px);
    }

    .video-container {
        width: 100%;
        height: 240px;
        background-color: #1e293b;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        border: 2px solid #fff;
    }

    .hero-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .avatar-container {
        position: relative;
        width: 120px; 
        height: 120px;
    }

    .agent-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f0fdf4;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* Typography */
    h1 {
        color: #0f172a;
        font-size: 24px;
        font-weight: 800;
        line-height: 1.3;
        margin-top: 10px;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
    }

    p {
        color: #64748b;
        font-size: 16px;
        font-weight: 600;
        line-height: 1.5;
        margin-bottom: 10px;
    }

    .sub-header {
        color: #94a3b8;
        font-size: 17px;
        font-weight: 700;
        margin-bottom: 20px;
    }

    /* Inputs & Grid */
    .input-group { width: 100%; text-align: left; margin-top: 10px; }
    .input-wrapper { position: relative; margin-top: 8px; }
    
    .custom-input {
        width: 100%;
        padding: 16px 16px 16px 50px;
        font-size: 18px;
        font-family: 'Nunito', sans-serif;
        font-weight: 700;
        color: #4b5563;
        background-color: white;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        outline: none;
        transition: all 0.2s ease;
        box-shadow: 0 4px 0 #e5e7eb;
    }
    .custom-input:focus { border-color: #58cc02; box-shadow: 0 4px 0 #58cc02; }
    
    .input-icon {
        position: absolute;
        left: 16px; top: 45%; transform: translateY(-50%);
        color: #58cc02; pointer-events: none;
    }

    .category-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        width: 100%; margin-bottom: 20px;
    }

    .cat-card {
        background: white; border: 2px solid #e5e7eb; border-radius: 16px;
        padding: 15px 10px; cursor: pointer; transition: all 0.15s ease;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; box-shadow: 0 4px 0 #e5e7eb;
    }
    .cat-card:active { transform: translateY(4px); box-shadow: 0 0px 0 #e5e7eb; }
    .cat-card.selected { border-color: #58cc02; background-color: #f0fdf4; box-shadow: 0 4px 0 #46a302; }
    .cat-card.selected:active { box-shadow: 0 0px 0 #46a302; }
    
    .cat-icon { font-size: 28px; margin-bottom: 8px; }
    .cat-name { font-weight: 700; font-size: 15px; color: #4b5563; }

    .helper-text {
        font-size: 13px; color: #64748b; margin-top: 15px;
        line-height: 1.4; text-align: left; display: flex;
        align-items: start; gap: 8px; background: rgba(255,255,255,0.5);
        padding: 10px; border-radius: 10px;
    }

    #other-input-container {
        width: 100%; overflow: hidden; max-height: 0; opacity: 0;
        transition: all 0.3s ease; margin-top: 0;
    }
    #other-input-container.open { max-height: 100px; opacity: 1; margin-top: 10px; }

    /* Shop Rules Cards */
    .setting-card {
        background: white; border-radius: 20px; padding: 16px;
        margin-bottom: 16px; width: 100%; text-align: left;
        box-shadow: 0 4px 0 #e5e7eb; border: 2px solid #e5e7eb;
    }
    
    .setting-header { display: flex; align-items: center; margin-bottom: 12px; }
    .setting-icon-bg {
        width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-right: 12px; font-size: 20px;
    }
    .icon-bg-blue { background-color: #e0f2fe; color: #0284c7; }
    .icon-bg-orange { background-color: #ffedd5; color: #c2410c; }
    .setting-title { font-weight: 800; font-size: 16px; color: #1e293b; }
    .setting-subtitle { font-size: 13px; color: #94a3b8; font-weight: 600; }

    .setting-input {
        width: 100%; padding: 12px; font-size: 16px;
        border: 2px solid #f1f5f9; background-color: #f8fafc;
        border-radius: 12px; outline: none; font-family: 'Nunito', sans-serif;
        font-weight: 700; color: #334155; transition: all 0.2s;
    }
    .setting-input:focus { border-color: #58cc02; background-color: white; }

    /* Utilities */
    .bottom-footer {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 2px solid #e5e7eb;
        padding: 16px 24px 24px 24px; z-index: 100;
        display: flex; flex-direction: column; align-items: center;
        padding-bottom: env(safe-area-inset-bottom);
    }

    .btn-start {
        display: block; width: 100%; max-width: 500px;
        background-color: #58cc02; color: white;
        font-size: 17px; font-weight: 800; text-transform: uppercase;
        text-decoration: none; padding: 16px 0; border-radius: 16px;
        border: none; cursor: pointer; box-shadow: 0 5px 0 #46a302;
        transition: transform 0.1s, box-shadow 0.1s; 
    }
    .btn-start:active, .btn-start.pressed { transform: translateY(4px); box-shadow: 0 0px 0 #46a302; }
    
    .btn-disabled {
        background-color: #e5e7eb; color: #9ca3af; box-shadow: none; pointer-events: none;
    }

    .footer-badge {
        margin-top: 15px; font-size: 12px; font-weight: 700; color: #cbd5e1;
        display: flex; align-items: center;
    }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .close-btn {
        position: absolute; top: 20px; right: 20px; background: none;
        border: none; cursor: pointer; color: #9ca3af; z-index: 10;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* =========================================
       NEW ADD PRODUCT SINGLE PAGE STYLES (FIXED)
       ========================================= */
    #step-add-product.screen-wrapper {
        background-color: #f8f8f6;
        padding-bottom: 0;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .ap-container { 
        padding: 20px; 
        max-width: 500px; 
        margin: 0 auto; 
        width: 100%; 
        padding-bottom: 40px;
    }
    .ap-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 10px; }
    .ap-back-btn { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: none; cursor: pointer; color: #0f1a14; }
    .ap-title-col { display: flex; flex-direction: column; align-items: center; }
    .ap-title { font-size: 18px; font-weight: 800; color: #0f1a14; }
    .ap-pro-badge { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #25d078; }
    .ap-star-icon { width: 40px; height: 40px; background: rgba(37, 208, 120, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #25d078; }

    /* Updated Photo Card for Gallery Support */
    .ap-photo-card {
        position: relative; width: 100%; aspect-ratio: 1/1; max-height: 320px;
        background: linear-gradient(135deg, rgba(255, 192, 110, 0.1), white);
        border: 2px dashed rgba(255, 192, 110, 0.4);
        border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 0 10px 25px -5px rgba(255, 192, 110, 0.15);
        overflow: hidden; 
        margin-bottom: 24px;
    }
    .ap-photo-content { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center; }
    
    .ap-photo-actions {
        display: flex; gap: 24px; margin-top: 20px;
    }
    .ap-action-btn {
        display: flex; flex-direction: column; align-items: center; gap: 8px;
        cursor: pointer; transition: transform 0.1s;
    }
    .ap-action-btn:active { transform: scale(0.95); }
    .ap-icon-circle {
        width: 60px; height: 60px; border-radius: 50%; background: white;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid #fff;
    }
    .ap-icon-circle.cam { color: #25d078; background: #ecfdf5; }
    .ap-icon-circle.gal { color: #ec7f13; background: #fff7ed; }
    .ap-action-btn span { font-size: 12px; font-weight: 700; color: #4b5563; }

    .ap-important-badge { position: absolute; top: -8px; right: -8px; background: #25d078; color: white; font-size: 10px; font-weight: 900; padding: 4px 12px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-transform: uppercase; z-index: 10; }
    
    /* Clean Preview */
    .ap-preview-container { position: absolute; inset: 0; width: 100%; height: 100%; background: white; z-index: 20; display: flex; align-items: center; justify-content: center; }
    .ap-preview-img { width: 100%; height: 100%; object-fit: cover; }
    .ap-remove-photo-btn { position: absolute; top: 12px; right: 12px; width: 36px; height: 36px; background: white; border-radius: 50%; color: #ef4444; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: none; cursor: pointer; z-index: 25; }
    .ap-change-photo-btn { position: absolute; bottom: 12px; right: 12px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; border: none; cursor: pointer; z-index: 25; display: flex; align-items: center; gap: 4px; backdrop-filter: blur(4px); }

    .ap-input-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(255, 192, 110, 0.15); margin-bottom: 16px; transition: transform 0.2s, border-color 0.2s; border: 1px solid transparent; }
    .ap-input-card:focus-within { transform: scale(1.02); border-color: #FFC06E; }
    .ap-label-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .ap-label-text { font-size: 14px; font-weight: 800; text-transform: uppercase; opacity: 0.6; letter-spacing: 0.5px; }
    .ap-text-input { width: 100%; border: none; outline: none; font-size: 20px; font-weight: 700; color: #0f1a14; background: transparent; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
    .ap-text-input::placeholder { color: #d1d5db; }

    .ap-cat-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
    .ap-cat-title { font-size: 14px; font-weight: 800; text-transform: uppercase; opacity: 0.6; }
    .ap-cat-link { font-size: 12px; font-weight: 800; color: #25d078; cursor: pointer;}
    .ap-cat-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; margin-bottom: 12px; }
    .ap-cat-scroll::-webkit-scrollbar { display: none; }
    .ap-cat-chip { flex-shrink: 0; padding: 12px 24px; border-radius: 50px; background: white; border: 1px solid #f3f4f6; color: #0f1a14; font-weight: 800; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; }
    .ap-cat-chip.active { background: #25d078; color: white; border-color: #25d078; box-shadow: 0 0 20px rgba(37, 208, 120, 0.4); }

    .ap-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .ap-small-label { font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; color: #9ca3af; }
    .ap-small-label.primary { color: #25d078; }
    .ap-price-row { display: flex; align-items: center; }
    .ap-currency { color: #25d078; font-weight: 800; margin-right: 4px; font-size: 18px; }

    .ap-stock-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(255, 192, 110, 0.15); display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .ap-stock-val { font-size: 24px; font-weight: 900; color: #25d078; }
    .ap-stock-ctrls { display: flex; gap: 16px; }
    .ap-stock-btn { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; border-bottom-width: 4px; border-style: solid; }
    .ap-btn-minus { background: #f9fafb; border-color: #e5e7eb; color: #0f1a14; }
    .ap-btn-plus { background: rgba(37, 208, 120, 0.1); border-color: rgba(37, 208, 120, 0.4); color: #25d078; }
    .ap-stock-btn:active { transform: translateY(2px); border-bottom-width: 0; }

    .ap-remind-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(255, 192, 110, 0.15); display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .ap-remind-left { display: flex; items-center: center; gap: 12px; }
    .ap-remind-icon { width: 40px; height: 40px; background: rgba(255, 192, 110, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #FFC06E; }
    .ap-toggle { width: 56px; height: 32px; background: #25d078; border-radius: 50px; position: relative; padding: 4px; cursor: pointer; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); transition: background 0.3s; }
    .ap-toggle.off { background: #e5e7eb; }
    .ap-toggle-dot { width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: absolute; right: 4px; transition: right 0.3s; }
    .ap-toggle.off .ap-toggle-dot { right: 28px; }

    /* Fixed Bottom Bar - MOVED TO FLOW STYLES */
    .ap-bottom-bar { 
        position: static;
        width: 100%;
        max-width: 100%;
        padding: 24px 0 40px 0;
        background: transparent;
        border: none;
        box-shadow: none;
        z-index: 1;
        margin-top: 10px;
    }
    .ap-save-btn-wrapper { max-width: 100%; margin: 0 auto; height: 64px; position: relative; }
    .ap-save-btn { width: 100%; height: 100%; background: #25d078; color: white; border-radius: 16px; border: none; font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 208, 120, 0.3); transition: transform 0.2s; position: absolute; inset: 0; }
    .ap-save-btn:active { transform: scale(0.96); }

    .ap-loading-state, .ap-success-state { display: none; width: 100%; height: 100%; align-items: center; justify-content: center; border-radius: 16px; position: absolute; inset: 0; }
    .ap-loading-state { background: rgba(37, 208, 120, 0.9); color: white; }
    .ap-success-state { background: #10b981; color: white; box-shadow: 0 0 30px rgba(16, 185, 129, 0.5); animation: bounceSuccess 0.5s ease-in-out infinite alternate; }

    .magic-spin { animation: spinMagic 1.5s linear infinite; font-size: 32px; }
    .confetti-particle { position: absolute; width: 6px; height: 6px; background: #FFC06E; border-radius: 2px; animation: confetti-fall 1s ease-out forwards; }
    .ripple { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.4); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; }

    @keyframes pulseSlow { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(0.98); } }
    @keyframes spinMagic { from { transform: rotate(0deg) scale(1.2); } to { transform: rotate(360deg) scale(1.2); } }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }
    @keyframes bounceSuccess { from { transform: scale(1); } to { transform: scale(1.02); } }
    @keyframes confetti-fall { 0% { transform: translate(0, 0) rotate(0); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(360deg); opacity: 0; } }
    
    /* Variant Chips */
    .variant-chips-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .variant-chip {
        padding: 8px 16px;
        border-radius: 50px;
        background: #f3f4f6;
        border: 2px solid #e5e7eb;
        color: #4b5563;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .variant-chip.active {
        background: #25d078;
        color: white;
        border-color: #25d078;
    }

    .variant-chip:active {
        transform: scale(0.95);
    }
    
    /* Share Modal Styles */
    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .share-option-btn:active {
        transform: scale(0.95);
    }

    /* =========================================
       DASHBOARD & RECORD SALE STYLES
       ========================================= */

    /* --- Layout & Reset for Dashboard --- */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .app-container {
        max-width: 500px;
        margin: 0 auto;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column; 
        background-color: var(--bg-body);
        padding-bottom: 0;
        position: relative;
    }

    /* The Scrollable Area */
    .main-content {
        flex: 1; 
        overflow-y: auto; 
        padding-bottom: 20px;
        -webkit-overflow-scrolling: touch;
    }

    /* =========================================
       LUXE DASHBOARD REDESIGN (MODERN SHOP LOOK)
       ========================================= */

    /* Header */
    .luxe-header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    
    .luxe-logo {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--luxe-blue);
        letter-spacing: -0.5px;
        margin: 0;
    }
    
    .luxe-header-actions {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .luxe-icon {
        background: none;
        border: none;
        color: var(--luxe-text);
        cursor: pointer;
        padding: 0;
        display: flex;
    }

    /* NEW MODERN HERO */
    .modern-hero {
        position: relative;
        width: 100%;
        height: 400px; /* Tall hero */
        background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&q=80&w=800');
        background-size: cover;
        background-position: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 40px 24px;
        margin-bottom: 40px;
    }

    .modern-hero::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.4); /* Darker overlay for text readability */
        z-index: 1;
    }

    .modern-hero-content {
        position: relative;
        z-index: 2;
        color: white;
        max-width: 90%;
    }

    .hero-typewriter {
        font-family: 'Playfair Display', serif;
        font-size: 32px;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 24px;
        min-height: 80px; /* Space for text */
        display: block;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .hero-cursor {
        display: inline-block;
        width: 2px;
        height: 32px;
        background-color: #25d078;
        animation: blink 1s infinite;
        vertical-align: middle;
        margin-left: 4px;
    }

    .modern-btn {
        background: white;
        color: #0f172a;
        border: none;
        padding: 14px 32px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .modern-btn:active {
        transform: scale(0.95);
    }

    /* CUSTOMER STOREFRONT HERO - UPDATED CAROUSEL */
    .customer-hero {
        position: relative;
        width: 100%;
        height: 60vh; /* Responsive height */
        min-height: 400px;
        max-height: 600px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 60px 24px;
        margin-bottom: 48px;
        overflow: hidden;
        background: transparent;
    }

    /* Carousel Wrapper */
    .hero-carousel-wrapper {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    .hero-slide {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0;
        transition: opacity 1.5s ease-in-out, transform 6s linear;
        transform: scale(1);
    }

    .hero-slide.active {
        opacity: 1;
        transform: scale(1.05); /* Slight zoom effect */
    }

    /* Dark Overlay for Text Visibility */
    .hero-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(15, 23, 42, 0.3), rgba(15, 23, 42, 0.7));
        z-index: 1;
    }

    .customer-hero-content {
        position: relative;
        z-index: 3;
        color: white;
        max-width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Store Logo Circle */
    .customer-store-logo {
        width: 100px;
        height: 100px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: logoEntrance 1s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes logoEntrance {
        0% {
            transform: scale(0) rotate(-180deg);
            opacity: 0;
        }
        100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
    }

    .customer-store-logo .material-symbols-outlined {
        font-size: 48px;
        color: #25d078;
        font-variation-settings: 'FILL' 1;
    }

    /* Store Name */
    .customer-store-name {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 16px;
        letter-spacing: -1px;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        animation: fadeInDown 1s ease 0.2s both;
    }

    @keyframes fadeInDown {
        0% {
            opacity: 0;
            transform: translateY(-30px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Typewriter Welcome Message */
    .customer-welcome-message {
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-size: 18px;
        font-weight: 600;
        line-height: 1.6;
        margin-bottom: 32px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .customer-typewriter-text {
        display: inline-block;
    }

    .customer-cursor {
        display: inline-block;
        width: 3px;
        height: 20px;
        background-color: white;
        margin-left: 4px;
        animation: cursorBlink 1s infinite;
        vertical-align: middle;
    }

    @keyframes cursorBlink {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0; }
    }

    /* CTA Button */
    .customer-cta-btn {
        background: white;
        color: #1d4ed8;
        border: none;
        padding: 16px 40px;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 1s ease 0.4s both;
    }

    @keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(30px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .customer-cta-btn:active {
        transform: scale(0.95);
    }

    /* Trust Badges */
    .customer-trust-badges {
        display: flex;
        justify-content: center;
        gap: 32px;
        margin-top: 24px;
        animation: fadeIn 1s ease 0.6s both;
    }

    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }

    .trust-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: white;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .trust-badge .material-symbols-outlined {
        font-size: 24px;
        opacity: 1;
    }

    .trust-badge-text {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
    }

    /* Products Section Title */
    .customer-section-title {
        font-family: 'Playfair Display', serif;
        font-size: 28px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 24px;
        text-align: center;
        position: relative;
        padding-bottom: 16px;
    }

    .customer-section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 2px;
    }

    /* Enhanced Product Cards for Customers */
    .customer-product-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        animation: productFadeIn 0.6s ease forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes productFadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .customer-product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
    }

    .customer-product-card:active {
        transform: scale(0.98);
    }

    /* Customer Header (Sticky) */
    .customer-header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
    }

    .customer-header-logo {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .customer-logo-circle {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
    }

    .customer-logo-circle .material-symbols-outlined {
        color: white;
        font-size: 24px;
        font-variation-settings: 'FILL' 1;
    }

    .customer-header-name {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
        font-weight: 700;
        color: #0f172a;
        letter-spacing: -0.5px;
    }

    .customer-whatsapp-btn {
        background: #25D366;
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        transition: transform 0.2s;
    }

    .customer-whatsapp-btn:active {
        transform: scale(0.95);
    }

    /* MODERN PRODUCT GRID */
    .modern-products-container {
        padding: 0 20px 40px 20px;
    }

    .modern-section-title {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 24px;
        text-align: center;
    }

    .modern-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px 16px;
    }

    .modern-product-card {
        background: white;
        border-radius: 8px; /* Softer, slightly simpler */
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease;
        animation: fadeInUp 0.6s ease forwards;
        opacity: 0;
        transform: translateY(20px);
    }
    
    .modern-product-card:active {
        transform: scale(0.98);
    }

    .modern-img-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 0.85; /* Taller fashion ratio */
        background: #f3f4f6;
        overflow: hidden;
        border-radius: 8px; /* Round corners on image */
        margin-bottom: 12px;
    }

    .modern-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .modern-product-card:hover .modern-img {
        transform: scale(1.05); /* Slight zoom on interaction */
    }

    .stock-badge-modern {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        font-size: 10px;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .modern-details {
        text-align: left;
    }

    .modern-title {
        font-size: 14px;
        font-weight: 600;
        color: #334155;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .modern-price {
        font-size: 16px;
        font-weight: 800;
        color: #0f172a;
    }
    
    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }


    /* Trust Footer - Simplified for Modern look */
    .luxe-trust {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 0 20px 20px 20px;
        margin-top: 20px;
        text-align: center;
        opacity: 0.6;
    }
    
    .luxe-trust-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .luxe-trust-icon { color: var(--luxe-accent-blue); font-size: 24px; }
    .luxe-trust-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .luxe-trust-sub { font-size: 10px; color: #9ca3af; }


    /* --- BOTTOM NAV --- */
    .bottom-nav {
        flex-shrink: 0; 
        width: 100%;
        background: white;
        border-top: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        padding-bottom: env(safe-area-inset-bottom);
        height: 75px; 
        z-index: 200;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        position: relative; 
    }

    .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding-bottom: 8px;
        color: #9ca3af;
        cursor: pointer;
        transition: color 0.2s;
    }

    .nav-item.active { color: #16a34a; }
    .nav-icon { font-size: 26px; margin-bottom: 4px; }
    .nav-label { font-size: 11px; font-weight: 700; }

    /* CENTER "ONGEZA" BUTTON */
    .nav-item.center-action { position: relative; overflow: visible; }

    .floating-add-btn {
        position: absolute;
        top: -25px; 
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 60px;
        background-color: #58cc02;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 6px 15px rgba(88, 204, 2, 0.4);
        border: 4px solid #f8f7f6; 
        transition: transform 0.1s;
    }

    .nav-item.center-action:active .floating-add-btn {
        transform: translateX(-50%) scale(0.95);
        box-shadow: 0 2px 8px rgba(88, 204, 2, 0.4);
    }

    .add-label { margin-top: 32px; color: #16a34a; font-weight: 800; }

    /* ADDED: PWA Install Card Styles (Used in Logic) */
    .pwa-install-card {
        background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
        border: 2px solid #22c55e;
        border-radius: 16px;
        padding: 12px 16px;
        margin: 0 auto 20px auto;
        max-width: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }

    /* PWA Dash Compact - Specific override for header button if used */
    .pwa-dash-compact {
        margin: 0 10px;
        padding: 6px 12px;
        font-size: 11px;
        background: var(--primary);
        color: white;
        border: none;
        box-shadow: none;
        animation: none;
    }

    /* --- ADDED: SETTINGS SCREEN STYLES --- */
    #step-profile .content-area { max-width: 600px; margin: 0 auto; padding-top: 20px; }
    
    .profile-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .profile-avatar-large {
        width: 100px; height: 100px;
        background: linear-gradient(135deg, #25d078, #1ea35e);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 16px;
        color: white;
        font-size: 40px; font-weight: 800;
        box-shadow: 0 10px 25px rgba(37, 208, 120, 0.3);
    }
    
    .profile-form-card {
        background: white;
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        border: 1px solid #f3f4f6;
        margin-bottom: 24px;
    }
    
    .pf-group { margin-bottom: 20px; text-align: left; }
    .pf-label { display: block; font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .pf-input-wrapper { position: relative; }
    .pf-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 20px; }
    
    .pf-input {
        width: 100%;
        padding: 16px 16px 16px 48px;
        font-size: 16px; font-weight: 600; color: #0f172a;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        outline: none;
        transition: all 0.2s;
    }
    .pf-input:focus { border-color: #25d078; background: white; }
    
    .pf-helper { font-size: 12px; color: #94a3b8; margin-top: 6px; line-height: 1.4; }
    
    .link-preview-box {
        background: #eff6ff;
        border: 1px dashed #bfdbfe;
        border-radius: 12px;
        padding: 12px;
        margin-top: 8px;
        font-size: 13px;
        color: #1e40af;
        display: flex; align-items: center; gap: 8px;
        word-break: break-all;
    }

    .save-profile-btn {
        width: 100%;
        padding: 18px;
        background: #0f172a;
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 16px; font-weight: 800;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
        cursor: pointer;
    }
    
    /* --- ADDED: DASHBOARD ALERT CARD --- */
    .setup-alert-card {
        background: #fff7ed;
        border: 1px solid #fed7aa;
        border-radius: 16px;
        padding: 16px;
        margin: 20px 20px 0 20px;
        display: flex; align-items: flex-start; gap: 12px;
        cursor: pointer;
        animation: slideDown 0.4s ease-out;
    }
    .sac-icon { color: #ea580c; background: #ffedd5; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .sac-content { flex: 1; text-align: left; }
    .sac-title { font-size: 15px; font-weight: 800; color: #9a3412; margin-bottom: 4px; }
    .sac-desc { font-size: 13px; color: #c2410c; line-height: 1.4; }
    
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- SALES ANALYTICS --- */
    .ana-tabs {
        display: flex;
        background: white;
        border-radius: 50px;
        padding: 4px;
        margin: 0 24px 20px 24px;
        border: 1px solid #e5e7eb;
    }
    .ana-tab {
        flex: 1;
        text-align: center;
        padding: 8px 0;
        font-size: 13px;
        font-weight: 700;
        color: #6b7280;
        border-radius: 40px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .ana-tab.active {
        background: #22c55e;
        color: white;
        box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2);
    }
    
    .ana-card-green {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 32px;
        padding: 24px;
        margin: 0 24px 24px 24px;
        color: white;
        text-align: left;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2);
    }
    .ana-cg-label { font-size: 14px; font-weight: 600; opacity: 0.9; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .ana-cg-amount { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
    .ana-cg-sub { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; display: inline-block; font-weight: 700; }
    
    .ana-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 24px; margin-bottom: 32px; }
    .ana-small-card { background: white; border-radius: 24px; padding: 20px; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.02); border: 1px solid #f3f4f6; }
    .asc-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    .asc-icon.green { background: #dcfce7; color: #16a34a; }
    .asc-icon.orange { background: #ffedd5; color: #ea580c; }
    .asc-label { font-size: 13px; color: #6b7280; font-weight: 600; margin-bottom: 4px; }
    .asc-val { font-size: 18px; font-weight: 800; color: #1f2937; }
    
    .ana-list-header { display: flex; justify-content: space-between; align-items: center; padding: 0 24px; margin-bottom: 16px; }
    .ana-lh-title { font-size: 18px; font-weight: 800; color: #111827; }
    .ana-lh-link { font-size: 13px; color: #16a34a; font-weight: 700; cursor: pointer; }
    .ana-list-container { padding: 0 24px 100px 24px; }
    .ana-list-item { background: white; border-radius: 20px; padding: 16px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .ali-left { display: flex; align-items: center; gap: 12px; }
    .ali-icon-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .ali-ic-green { background: #f0fdf4; color: #16a34a; }
    .ali-ic-orange { background: #fff7ed; color: #ea580c; }
    .ali-ic-blue { background: #eff6ff; color: #2563eb; }
    .ali-info h4 { font-size: 15px; font-weight: 700; color: #1f2937; margin-bottom: 2px; }
    .ali-info p { font-size: 12px; color: #9ca3af; }
    .ali-right { text-align: right; }
    .ali-amount { font-size: 15px; font-weight: 800; display: block; margin-bottom: 2px; }
    .ali-amount.pos { color: #16a34a; }
    .ali-amount.neg { color: #ea580c; }
    .ali-badge { font-size: 10px; font-weight: 700; color: #9ca3af; }
    .ali-badge.debt { background: #fff7ed; color: #c2410c; padding: 2px 6px; border-radius: 4px; }

    /* =========================================
       RECORD SALE (STEP 11) STYLES
       ========================================= */
    #step-11 {
        background-color: #f8fafc;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 500; /* Above everything */
        overflow-y: auto;
        display: flex; flex-direction: column;
    }

    /* Top Header Card */
    .sale-header-card {
        background: white;
        border-radius: 0 0 32px 32px;
        padding: 24px 24px 32px 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        display: flex; gap: 16px; align-items: flex-start;
        position: relative;
    }
    
    .sale-prod-img { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; background: #f1f5f9; }
    .sale-info { flex: 1; }
    .sale-title { font-size: 20px; font-weight: 800; color: #1f2937; line-height: 1.2; margin-bottom: 4px; }
    .sale-variant { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
    .sale-price-label { font-size: 11px; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-bottom: 2px; }
    .sale-price-val { font-size: 18px; font-weight: 800; color: #1f2937; }
    .stock-pill { background-color: #dcfce7; color: #166534; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; display: inline-block; margin-top: 4px; }
    
    .close-sale-btn {
        position: absolute; top: 20px; right: 20px;
        background: rgba(0,0,0,0.5); color: white;
        border-radius: 50%; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        border: none; cursor: pointer;
    }

    /* Toggle */
    .sale-toggle-container {
        margin: 24px 24px 16px 24px;
        background: white; border-radius: 50px;
        padding: 4px; display: flex;
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        border: 1px solid #e5e7eb;
    }
    .st-btn {
        flex: 1; text-align: center; padding: 12px 0;
        font-size: 14px; font-weight: 700; border-radius: 40px;
        color: #6b7280; transition: all 0.2s;
    }
    .st-btn.active { background-color: #3be32b; color: #052e16; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* Quantity Card */
    .sale-card-box { background: white; border-radius: 24px; margin: 0 24px 16px 24px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
    .sc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .sc-title { font-size: 12px; font-weight: 800; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
    .sc-stock-light { font-size: 12px; color: #3be32b; background: #f0fdf4; padding: 4px 8px; border-radius: 8px; font-weight: 700; }
    .qty-control-row { display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
    .qty-circle { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 400; cursor: pointer; border: none; }
    .qc-minus { background: #f3f4f6; color: #1f2937; }
    .qc-plus { background: #3be32b; color: #000; box-shadow: 0 4px 12px rgba(59, 227, 43, 0.4); }
    .qc-val { font-size: 32px; font-weight: 800; color: #111827; }

    /* Price Grid */
    .price-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 24px 24px 24px; }
    .pg-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
    .pg-label { font-size: 11px; font-weight: 800; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; }
    .pg-val { font-size: 22px; font-weight: 800; color: #1f2937; }
    .pg-val.green { color: #15803d; }
    .pg-input-line { width: 100%; height: 2px; background: #e5e7eb; margin-top: 4px; }

    /* Footer */
    .sale-footer { margin-top: auto; background: white; padding: 16px 24px 32px 24px; border-radius: 32px 32px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
    .sf-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .sf-label { font-size: 15px; color: #4b5563; font-weight: 600; }
    .sf-total { font-size: 20px; font-weight: 800; color: #111827; }
    
    .confirm-sale-btn { width: 100%; background-color: #3be32b; color: black; font-size: 16px; font-weight: 800; padding: 18px 0; border-radius: 50px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(59, 227, 43, 0.3); }

    /* AUTH STYLES */
    .auth-bg { background-image: radial-gradient(circle at 10% 20%, rgba(220, 252, 231, 0.4) 0%, rgba(255, 255, 255, 0.1) 90%); min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 24px; }
    .auth-header { text-align: center; margin-bottom: 24px; }
    .typewriter-text { font-size: 32px; font-weight: 800; color: #58cc02; margin-bottom: 8px; min-height: 42px; letter-spacing: -1px; }
    .auth-subtitle { color: #6b7280; font-size: 17px; font-weight: 700; }
    .auth-card { background: white; border-radius: 32px; padding: 24px; box-shadow: 0 8px 0 #e5e7eb, 0 8px 20px rgba(0,0,0,0.05); border: 2px solid #e5e7eb; position: relative; }
    .google-card-anim { margin-bottom: 20px; animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; transform: scale(0); opacity: 0; }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .google-btn { width: 100%; background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 16px; font-weight: 800; color: #374151; cursor: pointer; box-shadow: 0 4px 0 #e5e7eb; transition: all 0.1s; }
    .google-btn:active { box-shadow: 0 0 0 #e5e7eb; transform: translateY(4px); }
    .divider { display: flex; align-items: center; text-align: center; color: #9ca3af; font-size: 13px; font-weight: 700; margin: 20px 0; text-transform: uppercase; letter-spacing: 0.5px; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 2px solid #f1f5f9; }
    .divider:not(:empty)::before { margin-right: 12px; }
    .divider:not(:empty)::after { margin-left: 12px; }
    .auth-tabs { background: white; border-radius: 50px; padding: 0; display: flex; margin-bottom: 20px; position: relative; border-bottom: 2px solid #f1f5f9; }
    .auth-tab { flex: 1; text-align: center; padding: 12px 0; font-size: 15px; font-weight: 800; color: #9ca3af; cursor: pointer; z-index: 2; transition: color 0.3s ease; border-bottom: 3px solid transparent; }
    .auth-tab.active { color: #58cc02; border-bottom: 3px solid #58cc02; }
    .auth-input-group { margin-bottom: 16px; }
    .auth-label { display: block; font-size: 14px; font-weight: 800; color: #374151; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .email-field-wrapper, .password-wrapper { position: relative; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s; }
    .email-field-wrapper:focus-within, .password-wrapper:focus-within { border-color: #58cc02; background: white; }
    .field-icon { padding-left: 16px; color: #9ca3af; font-size: 22px; }
    .auth-input-field { flex: 1; background: transparent; border: none; padding: 16px; font-size: 17px; font-weight: 700; color: #1f2937; outline: none; font-family: 'Nunito', sans-serif; }
    .password-toggle { padding-right: 16px; color: #9ca3af; cursor: pointer; font-size: 22px; }
    .forgot-link { text-align: right; margin-bottom: 24px; }
    .forgot-link a { color: #9ca3af; font-size: 13px; font-weight: 700; text-decoration: none; text-transform: uppercase; }
    .auth-submit-btn { width: 100%; background-color: #58cc02; color: white; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 0 #46a302; transition: all 0.1s; }
    .auth-submit-btn:active { box-shadow: 0 0 0 #46a302; transform: translateY(4px); }
    .auth-footer { text-align: center; margin-top: 24px; }
    .auth-switch-text { color: #6b7280; font-size: 15px; font-weight: 700; }
    .auth-link { color: #58cc02; text-decoration: none; font-weight: 800; }
    .help-float { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 700; color: #4b5563; border: 2px solid #e5e7eb; cursor: pointer; }

    /* =========================================
       NEW AI SCREEN STYLES (VANILLA CSS)
       ========================================= */
    #step-ai.screen-wrapper { background-color: #fafafa; font-family: 'Spline Sans', sans-serif; color: #0f1a14; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    #ai-header { position: sticky; top: 0; z-index: 50; background-color: rgba(250, 250, 250, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid #f3f4f6; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
    .ai-header-left { display: flex; align-items: center; gap: 12px; }
    .ai-avatar-container { position: relative; width: 40px; height: 40px; }
    .ai-avatar-img { width: 100%; height: 100%; border-radius: 50%; background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDgqC1QMUD3bSxA-Tq3dw3g7fsCE4yvk_C0QYPqBbYq7l5cKgVNuPqGQep-tvPuzsotm6MEm-Ea2nkYTN9IiRPw3mApXi0moEZE6S73lyZr_f37U93AEDekxiuzP1WKXM97vyonP--8o86-eAZnOwIIlNE7ykI-aH9T6AzrOJinJOuD6-KUYM88lWoXt5-vPaepQjcaMgZTXqPKtDbuUbXj4O1R4j46AGyfVBvHGMgQocYn7_KVwYc_siRYa8W11RM8shSAbb1_22BJ'); background-size: cover; background-position: center; border: 2px solid #25d078; box-shadow: 0 0 0 0 rgba(37, 208, 120, 0.4); animation: aiPulse 2s infinite; }
    .ai-status-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background-color: #25d078; border-radius: 50%; border: 2px solid white; }
    .ai-header-text h1 { font-size: 16px; font-weight: 700; line-height: 1; margin: 0; color: #0f1a14; }
    .ai-header-status { font-size: 11px; color: #25d078; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .ai-header-actions { display: flex; gap: 8px; }
    .ai-icon-btn { padding: 8px; border-radius: 50%; background-color: #f3f4f6; border: none; cursor: pointer; color: #4b5563; display: flex; align-items: center; justify-content: center; }
    #ai-chat-stream { flex: 1; display: flex; flex-direction: column; gap: 24px; padding: 16px; padding-bottom: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .date-divider { display: flex; justify-content: center; margin-bottom: 8px; }
    .date-pill { padding: 4px 12px; background-color: #f3f4f6; border-radius: 50px; font-size: 10px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.1em; }
    .chat-row { display: flex; align-items: flex-end; gap: 12px; max-width: 85%; }
    .chat-row.user { align-self: flex-end; flex-direction: row-reverse; }
    .chat-avatar-small { width: 32px; height: 32px; border-radius: 50%; background-size: cover; background-position: center; flex-shrink: 0; border: 1px solid rgba(37, 208, 120, 0.2); }
    .chat-content { display: flex; flex-direction: column; gap: 4px; }
    .chat-name { font-size: 11px; font-weight: 500; color: #25d078; margin-left: 4px; }
    .chat-row.user .chat-name { color: #6b7280; margin-right: 4px; text-align: right; }
    .chat-bubble { padding: 12px 16px; font-size: 14px; line-height: 1.5; box-shadow: 0 4px 15px rgba(37, 208, 120, 0.1); }
    .chat-bubble.ai-response { background-color: white !important; color: #0f1a14 !important; border: 1px solid #e5e7eb !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important; border-radius: 12px; border-bottom-left-radius: 0; }
    .chat-bubble.user { background-color: #f3f4f6 !important; color: #0f1a14 !important; border: 1px solid #e5e7eb !important; border-radius: 12px; border-bottom-right-radius: 0; }
    .ai-empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px 0; gap: 16px; }
    .sparkle-container { position: relative; height: 60px; width: 200px; display: flex; justify-content: center; align-items: center; }
    .sparkle-wrapper { position: relative; width: 100%; animation: floatWave 6s ease-in-out infinite; }
    .star { position: absolute; background: radial-gradient(circle, #f78c26 20%, transparent 70%); border-radius: 50%; opacity: 0; animation: sparkleFade 2s linear infinite; }
    .ai-thinking-text { font-size: 14px; font-weight: 600; color: #25d078; font-style: italic; opacity: 0.8; animation: softPulse 2s ease-in-out infinite; }
    #ai-bottom-container { position: fixed; bottom: 0; left: 0; width: 100%; padding: 16px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(250,250,250,1) 80%, rgba(250,250,250,0.95) 95%, transparent); z-index: 60; display: flex; flex-direction: column; gap: 16px; }
    .suggestion-chips { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; -ms-overflow-style: none; scrollbar-width: none; }
    .suggestion-chips::-webkit-scrollbar { display: none; }
    .chip-btn { flex-shrink: 0; display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 50px; font-size: 13px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
    .chip-btn:active { transform: scale(0.95); }
    .chip-default { background: white; border: 1px solid rgba(247, 140, 38, 0.3); color: #374151; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .chip-accent { background: linear-gradient(135deg, #f78c26, #ea580c); color: white; border: none; box-shadow: 0 4px 10px rgba(247, 140, 38, 0.2); }
    .input-bar-wrapper { display: flex; align-items: center; gap: 8px; position: relative; }
    .ai-input-field-container { flex: 1; position: relative; }
    .ai-chat-input-styled { width: 100%; background: white; border: 2px solid #f3f4f6; border-radius: 50px; padding: 16px 48px 16px 24px; font-size: 14px; outline: none; font-family: 'Spline Sans', sans-serif; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); transition: all 0.2s; }
    .ai-chat-input-styled:focus { border-color: #25d078; box-shadow: 0 0 0 4px rgba(37, 208, 120, 0.1); }
    .attach-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; background: none; border: none; cursor: pointer; }
    .magic-send-btn { width: 56px; height: 56px; background: #25d078; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 208, 120, 0.3); transition: transform 0.1s; }
    .magic-send-btn:active { transform: scale(0.9); }
    @keyframes aiPulse { 0% { box-shadow: 0 0 0 0 rgba(37, 208, 120, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(37, 208, 120, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 208, 120, 0); } }
    @keyframes floatWave { 0%, 100% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-10px) translateX(10px); } 50% { transform: translateY(5px) translateX(20px); } 75% { transform: translateY(-5px) translateX(10px); } }
    @keyframes sparkleFade { 0%, 100% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } }
    @keyframes softPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    .cursor { display: inline-block; animation: blink 1s infinite; margin-left: 2px; font-weight: 400; }
    @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
    #ai-chat-stream { scroll-behavior: smooth; }

    /* =======================================================
       PRODUCT DETAIL PAGE STYLES
       ======================================================= */

    .product-detail-container {
        position: relative;
        width: 100%;
        height: 100vh;
        max-width: 600px;
        margin: 0 auto;
        background: #f6f7f8;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Top Navigation */
    .product-nav-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .product-back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        color: #0d171b;
    }

    .product-nav-actions {
        display: flex;
        gap: 8px;
    }

    .product-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        color: #0d171b;
    }

    /* Scrollable Content */
    .product-detail-scroll {
        flex: 1;
        overflow-y: auto;
        padding-top: 72px;
        padding-bottom: 100px;
        -webkit-overflow-scrolling: touch;
    }

    /* Product Image Gallery */
    .product-image-gallery {
        padding: 0 16px;
        margin-bottom: 24px;
    }

    .product-main-image {
        position: relative;
        width: 100%;
        min-height: 450px;
        border-radius: 16px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        background-image: linear-gradient(0deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0) 40%), url('https://via.placeholder.com/600');
    }

    .image-indicators {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 20px;
    }

    .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        transition: all 0.3s;
    }

    .indicator.active {
        background: white;
        width: 24px;
        border-radius: 4px;
    }

    /* Product Information */
    .product-info-section {
        padding: 0 16px;
    }

    .product-detail-title {
        font-family: 'Playfair Display', serif;
        font-size: 32px;
        font-weight: 700;
        color: #0d171b;
        line-height: 1.2;
        margin: 0 0 12px 0;
        letter-spacing: -0.5px;
    }

    .product-price-rating {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .product-detail-price {
        font-size: 28px;
        font-weight: 800;
        color: #25d078;
        margin: 0;
    }

    .product-rating-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(234, 179, 8, 0.1);
        padding: 6px 12px;
        border-radius: 50px;
    }

    .rating-star {
        font-size: 18px;
        color: #eab308;
        font-variation-settings: 'FILL' 1;
    }

    .rating-text {
        font-size: 12px;
        font-weight: 700;
        color: #a16207;
    }

    .product-description {
        font-size: 15px;
        line-height: 1.6;
        color: #64748b;
        margin: 0;
        font-weight: 400;
    }

    /* Stock Section */
    .product-stock-section {
        padding: 24px 16px 0 16px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #0d171b;
        margin: 0 0 12px 0;
    }

    .stock-status-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .stock-icon {
        font-size: 24px;
        color: #25d078;
    }

    .stock-text {
        font-size: 15px;
        font-weight: 600;
        color: #16a34a;
    }

    .stock-status-card.out-of-stock .stock-icon {
        color: #ef4444;
    }

    .stock-status-card.out-of-stock .stock-text {
        color: #dc2626;
    }

    /* Usage Section */
    .product-usage-section {
        padding: 24px 16px 0 16px;
    }

    .usage-card {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: #fff7ed;
        border-radius: 12px;
        border: 1px solid #fed7aa;
    }

    .usage-icon {
        font-size: 24px;
        color: #f78c26;
        flex-shrink: 0;
    }

    .usage-text {
        font-size: 14px;
        line-height: 1.5;
        color: #9a3412;
        margin: 0;
        font-weight: 500;
    }

    /* Accordion */
    .product-accordion {
        padding: 24px 16px;
    }

    .accordion-item {
        border-top: 1px solid #e5e7eb;
    }

    .accordion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        cursor: pointer;
    }

    .accordion-title {
        font-size: 15px;
        font-weight: 700;
        color: #334155;
    }

    .accordion-header .material-symbols-outlined {
        color: #94a3b8;
        font-size: 24px;
    }

    /* Sticky Bottom Bar */
    .product-bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 12px;
        align-items: center;
        z-index: 100;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .whatsapp-order-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #25D366;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        transition: transform 0.2s;
        flex-shrink: 0;
    }

    .whatsapp-order-btn:active {
        transform: scale(0.9);
    }

    .add-to-cart-btn {
        flex: 1;
        height: 56px;
        background: #25d078;
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(37, 208, 120, 0.3);
        transition: transform 0.2s;
    }

    .add-to-cart-btn:active {
        transform: scale(0.98);
    }

    /* Responsive - Larger Screens */
    @media (min-width: 640px) {
        .product-detail-container {
            border-radius: 24px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
    }

    /* New CSS for Variants and Share Modal */
    /* Variant Chips */
    .variant-chips-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .variant-chip {
        padding: 8px 16px;
        border-radius: 50px;
        background: #f3f4f6;
        border: 2px solid #e5e7eb;
        color: #4b5563;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .variant-chip.active {
        background: #25d078;
        color: white;
        border-color: #25d078;
    }

    .variant-chip:active {
        transform: scale(0.95);
    }

    /* Share Modal Styles */
    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .share-option-btn:active {
        transform: scale(0.95);
    }
    
</style>
</head>
<body>

<!-- STEP 0: AUTHENTICATION SCREEN -->
<div id="step-auth" class="screen-wrapper hidden auth-bg">
    
    <div class="auth-header">
        <h1 class="typewriter-text" id="typewriter">Karibu.</h1>
        <p class="auth-subtitle">Let's manage your shop today.</p>
    </div>

    <div class="pwa-install-card hidden" onclick="handlePWAClick()" style="
        margin: 0 auto 20px auto;
        max-width: 500px;
        background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
        border: 2px solid #22c55e;
        border-radius: 20px;
        padding: 16px 20px;
        display: none;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        transition: transform 0.2s;
    ">
        <span class="material-symbols-outlined" style="color:#16a34a; font-size: 32px;">download_for_offline</span>
        <div style="text-align: left; flex: 1;">
            <div style="color:#166534; font-weight:800; font-size:16px;">Pakua App</div>
            <div style="color:#166534; font-size:13px; opacity:0.8;">Tumia bila mtandao</div>
        </div>
        <span class="material-symbols-outlined" style="color:#16a34a; font-size:24px;">chevron_right</span>
    </div>

    <div class="auth-card">
        <div class="google-card-anim">
            <button class="google-btn" onclick="handleGoogleAuth()">
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>

        <div class="divider">or email</div>

        <div class="auth-tabs">
            <div class="auth-tab active" id="tab-login" onclick="toggleAuthMode('login')">LOGIN</div>
            <div class="auth-tab" id="tab-signup" onclick="toggleAuthMode('signup')">SIGN UP</div>
        </div>

        <div class="auth-input-group">
            <label class="auth-label">Email Address</label>
            <div class="email-field-wrapper">
                <span class="material-symbols-outlined field-icon">mail</span>
                <input type="email" id="auth-email" class="auth-input-field" placeholder="name@email.com">
            </div>
        </div>

        <div class="auth-input-group">
            <label class="auth-label">Password</label>
            <div class="password-wrapper">
                <span class="material-symbols-outlined field-icon">lock</span>
                <input type="password" id="auth-pass" class="auth-input-field" placeholder="6+ characters">
                <span class="material-symbols-outlined password-toggle" onclick="togglePassVisibility()">visibility_off</span>
            </div>
        </div>

        <div class="forgot-link">
            <a href="#">Forgot Password?</a>
        </div>

        <button class="auth-submit-btn" onclick="handleAuth()">
            <span id="auth-btn-text">Ingia (Login)</span>
        </button>
    </div>

    <div class="auth-footer">
        <span class="auth-switch-text" id="auth-footer-text">Don't have an account? </span>
        <a href="#" class="auth-link" id="auth-footer-link" onclick="toggleAuthMode('signup')">CREATE ONE</a>
    </div>

    <div class="help-float">
        <span class="material-symbols-outlined" style="color: #58cc02;">support_agent</span>
        Need Help?
    </div>
</div>

<!-- STEPS 1-4 -->
<div id="step-1" class="screen-wrapper hidden">
    <div class="media-card"><div class="video-container"><video class="hero-video" src="https://vqgnxqabvmmpfoiceass.supabase.co/storage/v1/object/public/post-images/grok_video_2026-01-01-15-58-00.mp4" autoplay loop muted playsinline></video></div></div>
    <div class="content-area"><h1>Biashara yako iendelee hata ukiwa umelala</h1><p>Weka bidhaa zako mara moja, AI itahudumia wateja wako</p></div>
    <div class="bottom-footer"><button id="btn-step-1" class="btn-start" onclick="handleStep1Click()">Anza <span class="arrow-icon">&rarr;</span></button><div class="footer-badge"> Secured by WhatsApp</div></div>
</div>
<div id="step-2" class="screen-wrapper hidden">
    <button class="close-btn" onclick="goBack()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
    <div class="media-card"><div class="avatar-container"><img src="https://vqgnxqabvmmpfoiceass.supabase.co/storage/v1/object/public/post-images/file_00000000f48c71fda7ebace03538d6f8.png" alt="Agent Hiba" class="agent-avatar"><div class="speech-bubble"></div></div></div>
    <div class="content-area"><h1>Let's get started! What is your business called?</h1><div class="sub-header">Jina la duka lako</div><div class="input-group"><div class="input-wrapper"><svg class="input-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4 8H20V21H4V8Z" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linejoin="round"/><path d="M4 8L7.33333 3H16.6667L20 8" stroke="currentColor" stroke-width="2.5" stroke-linejoin="round"/></svg><input type="text" id="shop-name-input" class="custom-input" placeholder="e.g., Duka la Asha"></div><div class="helper-text"><span style="color:#58cc02; font-weight:bold; font-size: 16px;">i</span><div>Customers will see this name on WhatsApp.<br><span style="font-style: italic; opacity: 0.8;">Wateja wataona jina hili kwenye WhatsApp.</span></div></div></div></div>
    <div class="bottom-footer"><button id="btn-step-2" class="btn-start" onclick="handleStep2Click()">Continue <span class="arrow-icon">&rarr;</span></button><div class="footer-badge"> Safe & Secure  Salama</div></div>
</div>
<div id="step-3" class="screen-wrapper hidden">
    <button class="close-btn" onclick="goBack()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
    <div class="media-card"><div class="avatar-container"><img src="https://vqgnxqabvmmpfoiceass.supabase.co/storage/v1/object/public/post-images/file_00000000f48c71fda7ebace03538d6f8.png" alt="Agent Hiba" class="agent-avatar"></div></div>
    <div class="content-area"><h1>What do you sell?</h1><div class="sub-header">Pick the category that fits best.</div><div class="category-grid"><div class="cat-card" onclick="selectCategory(this, 'Clothes')"><span class="cat-icon"></span><span class="cat-name">Clothes</span></div><div class="cat-card" onclick="selectCategory(this, 'Food')"><span class="cat-icon"></span><span class="cat-name">Food</span></div><div class="cat-card" onclick="selectCategory(this, 'Electronics')"><span class="cat-icon"></span><span class="cat-name">Electronics</span></div><div class="cat-card" onclick="selectCategory(this, 'Beauty')"><span class="cat-icon"></span><span class="cat-name">Beauty</span></div><div class="cat-card" onclick="selectCategory(this, 'Home')"><span class="cat-icon"></span><span class="cat-name">Home</span></div><div class="cat-card" onclick="selectCategory(this, 'Other')"><span class="cat-icon"></span><span class="cat-name">Other</span></div></div><div id="other-input-container"><div class="input-wrapper"><input type="text" id="cat-other-input" class="custom-input" placeholder="Type your category..."></div></div></div>
    <div class="bottom-footer"><button id="btn-step-3" class="btn-start" onclick="handleStep3Click()">Continue <span class="arrow-icon">&rarr;</span></button><div class="footer-badge"> Safe & Secure  Salama</div></div>
</div>
<div id="step-4" class="screen-wrapper hidden">
    <button class="close-btn" onclick="goBack()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
    <div class="media-card"><div class="avatar-container"><img src="https://vqgnxqabvmmpfoiceass.supabase.co/storage/v1/object/public/post-images/file_00000000f48c71fda7ebace03538d6f8.png" alt="Agent Hiba" class="agent-avatar"><div class="speech-bubble">Karibu! </div></div></div>
    <div class="content-area"><h1>Let's set your shop rules, Rafiki</h1><div class="sub-header">Choose how you want to handle orders and alerts.</div><div class="setting-card"><div class="setting-header"><div class="setting-icon-bg icon-bg-blue"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.04-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div><div><div class="setting-title">WhatsApp Business</div><div class="setting-subtitle">Used for notifications</div></div></div><input type="tel" id="whatsapp-input" class="setting-input" placeholder="e.g. 0712 345 678"></div><div class="setting-card"><div class="setting-header"><div class="setting-icon-bg icon-bg-orange"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div><div><div class="setting-title">Lipa Namba</div><div class="setting-subtitle">Voda / Airtel / Tigo / M-Pesa</div></div></div><input type="number" id="lipa-input" class="setting-input" placeholder="e.g. 5566778"></div></div>
    <div class="bottom-footer"><button id="btn-step-4" class="btn-start" onclick="handleStep4Click()">Sawa, Endelea <span class="arrow-icon">&rarr;</span></button><div class="footer-badge"> Safe & Secure  Salama</div></div>
</div>

<!-- STEP 5: STORE DASHBOARD (MODERN E-COMMERCE DESIGN) -->
<div id="step-5" class="screen-wrapper hidden">
    <div class="app-container">
        <!-- Header -->
        <header class="luxe-header">
            <!-- UPDATED: Added Profile Settings Button -->
            <button class="luxe-icon" onclick="openProfileSettings()">
                <span class="material-symbols-outlined">settings</span>
            </button>
            <h1 class="luxe-logo" id="dash-business-name">LINKA.</h1>
            <div class="luxe-header-actions">
                <button class="luxe-icon" onclick="copyStorefrontLink()" style="background: #25d078; color: white; padding: 6px 14px; border-radius: 50px; display: flex; align-items: center; gap: 4px;">
                    <span class="material-symbols-outlined" style="font-size:18px;">share</span>
                    <span style="font-size: 12px; font-weight: 700;">Link</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            
            <!-- ADDED: SETUP ALERT (Visible if data missing) -->
            <div id="setup-alert" class="setup-alert-card hidden" onclick="openProfileSettings()">
                <div class="sac-icon">
                    <span class="material-symbols-outlined">priority_high</span>
                </div>
                <div class="sac-content">
                    <div class="sac-title">Receive Orders</div>
                    <div class="sac-desc">Add your WhatsApp number so customers can send orders directly to you.</div>
                </div>
                <span class="material-symbols-outlined" style="color:#c2410c; margin-top:10px;">arrow_forward</span>
            </div>

            <!-- Hero -->
            <div class="modern-hero">
                <div class="modern-hero-content">
                    <span class="hero-typewriter" id="hero-typewriter-text"></span><span class="hero-cursor"></span>
                    <button class="modern-btn" onclick="goToAddProduct()">Ongeza Bidhaa</button>
                </div>
            </div>

            <!-- Products -->
            <div class="modern-products-container">
                <div class="modern-section-title">
                    <span>New Arrivals</span>
                </div>
                
                <div class="modern-grid" id="products-container">
                    <!-- Products Injected Here via JS with Modern Animation -->
                </div>
            </div>

            <!-- Trust Footer -->
            <div class="luxe-trust">
                <div class="luxe-trust-item">
                    <span class="material-symbols-outlined luxe-trust-icon">verified_user</span>
                    <div>
                        <div class="luxe-trust-title">Secure Data</div>
                        <div class="luxe-trust-sub">Encrypted</div>
                    </div>
                </div>
                <div class="luxe-trust-item">
                    <span class="material-symbols-outlined luxe-trust-icon">cloud_sync</span>
                    <div>
                        <div class="luxe-trust-title">Auto Sync</div>
                        <div class="luxe-trust-sub">Always Online</div>
                    </div>
                </div>
            </div>

            <!-- Hidden elements to preserve JS logic looking for specific IDs -->
            <div id="dash-greeting" class="hidden"></div>
            <div id="profile-avatar" class="hidden"></div>
            <div id="debtors-container" class="hidden"></div>
            <!-- Removed Stat IDs handled in JS logic to prevent errors -->

        </div>
    
        <!-- Bottom Nav - Preserved -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="loadDashboard()">
                <span class="material-symbols-outlined nav-icon">home</span>
                <span class="nav-label">Nyumbani</span>
            </div>
            <div class="nav-item" onclick="goToAnalytics()">
                <span class="material-symbols-outlined nav-icon">bar_chart</span>
                <span class="nav-label">Mauzo</span>
            </div>
            <div class="nav-item center-action" onclick="goToAddProduct()">
                <div class="floating-add-btn">
                    <span class="material-symbols-outlined" style="font-size:32px;">add</span>
                </div>
                <span class="nav-label add-label">Ongeza</span>
            </div>
            <div class="nav-item" onclick="goToAI()">
                <span class="material-symbols-outlined nav-icon">auto_awesome</span>
                <span class="nav-label">AI</span>
            </div>
        </div>
    </div>
</div>

<!-- ADDED: STORE PROFILE SETTINGS SCREEN -->
<div id="step-profile" class="screen-wrapper hidden" style="background: #f8fafc;">
    <div class="app-container">
        <!-- Nav -->
        <div class="luxe-header">
            <button class="luxe-icon" onclick="loadDashboard()">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="luxe-logo">Shop Settings</h1>
            <div style="width: 24px;"></div>
        </div>

        <div class="content-area">
            <div class="profile-header">
                <div class="profile-avatar-large" id="settings-avatar">S</div>
                <h2 style="font-size: 20px; color: #0f172a; margin-bottom: 4px;">Store Profile</h2>
                <p style="font-size: 14px; color: #64748b;">Manage how customers see you</p>
            </div>

            <div class="profile-form-card">
                <!-- Shop Name Input -->
                <div class="pf-group">
                    <label class="pf-label">Shop Name (Jina la Duka)</label>
                    <div class="pf-input-wrapper">
                        <span class="material-symbols-outlined pf-icon">storefront</span>
                        <input type="text" id="prof-shop-name" class="pf-input" placeholder="e.g. Mama John Store" oninput="updateLinkPreview()">
                    </div>
                </div>

                <!-- WhatsApp Input with Country Code Selector -->
                <div class="pf-group">
                    <label class="pf-label">WhatsApp for Orders (Namba ya Simu)</label>
                    <div class="pf-input-wrapper" style="display: flex; gap: 0;">
                        <select id="country-code-select" style="
                            padding: 16px 12px;
                            font-size: 16px;
                            font-weight: 700;
                            color: #0f172a;
                            background: #f8fafc;
                            border: 2px solid #e2e8f0;
                            border-right: none;
                            border-radius: 12px 0 0 12px;
                            outline: none;
                            cursor: pointer;
                        ">
                            <option value="+255"> +255</option>
                            <option value="+254"> +254</option>
                            <option value="+256"> +256</option>
                            <option value="+250"> +250</option>
                        </select>
                        <input type="tel" id="prof-phone" class="pf-input" placeholder="712345678" style="
                            border-radius: 0 12px 12px 0;
                            padding-left: 16px;
                            flex: 1;
                        ">
                    </div>
                    <div class="pf-helper">Orders will be sent to this number via WhatsApp.</div>
                </div>

                <!-- Link Preview -->
                <div class="pf-group">
                    <label class="pf-label">Your Store Link</label>
                    <div class="link-preview-box">
                        <span class="material-symbols-outlined" style="font-size:16px;">link</span>
                        <span id="prof-link-preview">...</span>
                    </div>
                    <div class="pf-helper">Share this short link with customers.</div>
                </div>
            </div>

            <button class="save-profile-btn" onclick="saveShopProfile()">
                <span class="material-symbols-outlined">save</span>
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- =======================================================
     ADDED: SALES ANALYTICS PAGE (New Screen)
     ======================================================= -->
<div id="step-analytics" class="screen-wrapper hidden">
    <div class="app-container">
        <!-- Header -->
        <div class="dash-header" style="padding: 16px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="profile-section" style="display:flex; align-items:center; gap:12px;">
                <div class="profile-img" id="ana-profile-avatar"></div>
                <div class="profile-info">
                    <p style="font-size: 11px; text-transform: uppercase; font-weight: 800; color: #9ca3af;">HABARI,</p>
                    <h2 id="ana-business-name" style="font-size: 20px;">User!</h2>
                </div>
            </div>
            <button class="close-icon-btn" onclick="loadDashboard()"><span class="material-symbols-outlined">close</span></button>
        </div>

        <!-- Tabs -->
        <div class="ana-tabs">
            <div class="ana-tab active" onclick="loadAnalytics('today', this)">Leo</div>
            <div class="ana-tab" onclick="loadAnalytics('week', this)">Wiki</div>
            <div class="ana-tab" onclick="loadAnalytics('month', this)">Mwezi</div>
        </div>

        <div class="main-content">
            <!-- Big Green Card -->
            <div class="ana-card-green">
                <div class="ana-cg-label">
                    <span class="material-symbols-outlined" style="font-size: 18px;">account_balance_wallet</span>
                    Faida Yako (Sales)
                </div>
                <div class="ana-cg-amount" id="ana-total-profit">0 TZS</div>
                <div class="ana-cg-sub">+12% Kulinganisha na jana</div>
            </div>

            <!-- Small Cards Grid -->
            <div class="ana-grid">
                <div class="ana-small-card">
                    <div class="asc-icon green"><span class="material-symbols-outlined">payments</span></div>
                    <div class="asc-label">Mauzo</div>
                    <div class="asc-val" id="ana-sales-val">0 TZS</div>
                </div>
                <div class="ana-small-card">
                    <div class="asc-icon orange"><span class="material-symbols-outlined">warning</span></div>
                    <div class="asc-label">Madeni</div>
                    <div class="asc-val" id="ana-debt-val">0 TZS</div>
                </div>
            </div>

            <!-- Recent List -->
            <div class="ana-list-header">
                <div class="ana-lh-title">Hivi Karibuni</div>
                <div class="ana-lh-link">Ona Zote</div>
            </div>

            <div class="ana-list-container" id="ana-list-container">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="loadDashboard()">
                <span class="material-symbols-outlined nav-icon">home</span>
                <span class="nav-label">Nyumbani</span>
            </div>
            <div class="nav-item active" onclick="goToAnalytics()">
                <span class="material-symbols-outlined nav-icon">bar_chart</span>
                <span class="nav-label">Mauzo</span>
            </div>
            <div class="nav-item center-action" onclick="goToAddProduct()">
                <div class="floating-add-btn">
                    <span class="material-symbols-outlined" style="font-size:32px;">add</span>
                </div>
                <span class="nav-label add-label">Ongeza</span>
            </div>
            <div class="nav-item" onclick="goToAI()">
                <span class="material-symbols-outlined nav-icon">auto_awesome</span>
                <span class="nav-label">AI</span>
            </div>
        </div>
    </div>
</div>

<!-- =======================================================
     REPLACED: SINGLE PAGE ADD PRODUCT
     ======================================================= -->
<div id="step-add-product" class="screen-wrapper hidden">
    <!-- Hidden File Inputs -->
    <!--  ALLOW MULTIPLE IMAGES -->
    <input type="file" id="camera-input" capture="environment" accept="image/*" hidden onchange="handleImageUpload(this)">
    <input type="file" id="gallery-input" accept="image/*" multiple hidden onchange="handleMultipleImageUpload(this)">

    <div class="ap-container">
        <!-- Navigation -->
        <nav class="ap-nav">
            <button class="ap-back-btn" onclick="closeAddProduct()">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div class="ap-title-col">
                <h1 class="ap-title">Ongeza Bidhaa</h1>
                <span class="ap-pro-badge">Kwa Ustadi (Pro)</span>
            </div>
            <div class="ap-star-icon">
                <span class="material-symbols-outlined" style="font-weight: 700;">star</span>
            </div>
        </nav>

        <!-- UPDATED: Photo Card with Gallery Support -->
        <div class="ap-photo-card" id="ap-photo-card-container">
            <!-- Empty State -->
            <div id="ap-photo-empty" class="ap-photo-content">
                <div class="ap-important-badge">MUHIMU</div>
                <div style="text-align:center; margin-bottom:16px;">
                    <div style="font-weight:800; color:#0f1a14; margin-bottom:4px;">Picha ya Bidhaa</div>
                    <div style="font-size:12px; color:#9ca3af;">Chagua picha au piga mpya</div>
                </div>
                
                <div class="ap-photo-actions">
                    <!-- Camera -->
                    <div class="ap-action-btn" onclick="triggerCamera()">
                        <div class="ap-icon-circle cam">
                            <span class="material-symbols-outlined">photo_camera</span>
                        </div>
                        <span>Camera</span>
                    </div>
                    <!-- Gallery -->
                    <div class="ap-action-btn" onclick="triggerGallery()">
                        <div class="ap-icon-circle gal">
                            <span class="material-symbols-outlined">image</span>
                        </div>
                        <span>Gallery</span>
                    </div>
                </div>
            </div>

            <!-- Preview State (Clean Review) -->
            <div id="ap-photo-preview" class="ap-preview-container hidden">
                <img id="ap-preview-img" class="ap-preview-img" src="">
                <button class="ap-remove-photo-btn" onclick="resetPhoto()">
                    <span class="material-symbols-outlined">delete</span>
                </button>
                <button class="ap-change-photo-btn" onclick="triggerGallery()">
                    <span class="material-symbols-outlined">edit</span> Change
                </button>
            </div>
        </div>

        <!-- Product Name Input -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#25d078; font-size: 20px;">label</span>
                <span class="ap-label-text">Jina la Bidhaa</span>
            </div>
            <input id="new-prod-name" class="ap-text-input" placeholder="Mf: Sabuni ya Miche 5" type="text" />
        </div>

        <!-- ADDED: Usage Instructions (for medicine/dosage) -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#f78c26; font-size: 20px;">medication</span>
                <span class="ap-label-text">Maelezo ya Matumizi (Optional)</span>
            </div>
            <input id="new-prod-usage" class="ap-text-input" placeholder="Mf: Mara 2 kwa siku, Max 3 vidonge" type="text" style="font-size: 16px;" />
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; font-weight: 600;">
                Kwa dawa: Andika jinsi ya kutumia na kiwango cha juu (For medicine: dosage & max amount)
            </p>
        </div>

        <!-- ADDED: Full Product Description -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#3b82f6; font-size: 20px;">description</span>
                <span class="ap-label-text">Maelezo ya Bidhaa (Description)</span>
            </div>
            <textarea id="new-prod-full-desc" class="ap-text-input" placeholder="E.g. This premium quality soap is made from natural ingredients..." rows="4" style="resize: vertical; padding: 12px; line-height: 1.5;"></textarea>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; font-weight: 600;">
                Full description shown to customers (Optional)
            </p>
        </div>

        <!-- ADDED: Product Variants (Color, Size, Material) -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#8b5cf6; font-size: 20px;">palette</span>
                <span class="ap-label-text">Rangi Zinazopatikana (Colors)</span>
            </div>
            <div class="variant-chips-container" id="color-chips">
                <button class="variant-chip" onclick="toggleVariantChip(this, 'color', 'Red')"> Red</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'color', 'Blue')"> Blue</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'color', 'Green')"> Green</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'color', 'Black')"> Black</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'color', 'White')"> White</button>
            </div>
            <input id="custom-color-input" class="ap-text-input" placeholder="Ongeza rangi nyingine..." type="text" style="margin-top: 8px; font-size: 14px;" />
        </div>

        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#f59e0b; font-size: 20px;">straighten</span>
                <span class="ap-label-text">Saizi Zinazopatikana (Sizes)</span>
            </div>
            <div class="variant-chips-container" id="size-chips">
                <button class="variant-chip" onclick="toggleVariantChip(this, 'size', 'S')">S</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'size', 'M')">M</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'size', 'L')">L</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'size', 'XL')">XL</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'size', 'XXL')">XXL</button>
            </div>
        </div>

        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#10b981; font-size: 20px;">category</span>
                <span class="ap-label-text">Aina ya Nyenzo (Material)</span>
            </div>
            <div class="variant-chips-container" id="material-chips">
                <button class="variant-chip" onclick="toggleVariantChip(this, 'material', 'Cotton')">Cotton</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'material', 'Plastic')">Plastic</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'material', 'Metal')">Metal</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'material', 'Wood')">Wood</button>
                <button class="variant-chip" onclick="toggleVariantChip(this, 'material', 'Glass')">Glass</button>
            </div>
        </div>

        <!-- Category Section -->
        <div>
            <div class="ap-cat-row">
                <span class="ap-cat-title">Aina ya Bidhaa</span>
                <span class="ap-cat-link">Ona Zote</span>
            </div>
            <div class="ap-cat-scroll">
                <button class="ap-cat-chip" onclick="selectNewCategory(this, 'Chakula')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">inventory_2</span> Chakula
                </button>
                <button class="ap-cat-chip" onclick="selectNewCategory(this, 'Nguo')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">checkroom</span> Nguo
                </button>
                <button class="ap-cat-chip" onclick="selectNewCategory(this, 'Vifaa')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">home_repair_service</span> Vifaa
                </button>
                <button class="ap-cat-chip" onclick="selectNewCategory(this, 'Nyingine')">
                    <span class="material-symbols-outlined" style="font-size: 18px;">category</span> Nyingine
                </button>
            </div>
        </div>

        <!-- Price Grid -->
        <div class="ap-grid-2">
            <div class="ap-input-card">
                <p class="ap-small-label">Bei ya Kununua</p>
                <div class="ap-price-row">
                    <span class="ap-currency">TSh</span>
                    <input id="new-prod-cost" class="ap-text-input" placeholder="0" type="number" />
                </div>
            </div>
            <div class="ap-input-card">
                <p class="ap-small-label primary">Bei ya Kuuza</p>
                <div class="ap-price-row">
                    <span class="ap-currency">TSh</span>
                    <input id="new-prod-price" class="ap-text-input" placeholder="0" type="number" />
                </div>
            </div>
        </div>

        <!-- ADDED: Discount/Offer Section -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#ef4444; font-size: 20px;">local_offer</span>
                <span class="ap-label-text">Punguzo/Offer (Optional)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <input type="checkbox" id="has-discount-check" onchange="toggleDiscountSection()" style="width: 20px; height: 20px; cursor: pointer;" />
                <label for="has-discount-check" style="cursor: pointer; font-weight: 600;">Bidhaa ina punguzo?</label>
            </div>
            <div id="discount-inputs" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <p class="ap-small-label">Bei ya Zamani</p>
                    <input id="original-price-input" class="ap-text-input" placeholder="50000" type="number" style="font-size: 16px;" />
                </div>
                <div>
                    <p class="ap-small-label">Punguzo %</p>
                    <input id="discount-percent-input" class="ap-text-input" placeholder="20" type="number" max="100" style="font-size: 16px;" />
                </div>
            </div>
        </div>

        <!-- FIXED: Stock Input - Now Editable -->
        <div class="ap-input-card">
            <div class="ap-label-row">
                <span class="material-symbols-outlined" style="color:#25d078; font-size: 20px;">inventory</span>
                <span class="ap-label-text">Idadi ya Stock</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="ap-stock-btn ap-btn-minus" onclick="updateNewStock(-1)" style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; border-bottom-width: 4px; border-style: solid; background: #f9fafb; border-color: #e5e7eb; color: #0f1a14;">
                    <span class="material-symbols-outlined">remove</span>
                </button>
                <input id="new-stock-input" class="ap-text-input" type="number" min="0" value="1" style="text-align: center; font-size: 24px; font-weight: 900; color: #25d078; width: 100px; padding: 8px;" oninput="syncStockValue(this.value)" />
                <button class="ap-stock-btn ap-btn-plus" onclick="updateNewStock(1)" style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; border-bottom-width: 4px; border-style: solid; background: rgba(37, 208, 120, 0.1); border-color: rgba(37, 208, 120, 0.4); color: #25d078;">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>
            <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; font-weight: 600;">
                Unaweza kuandika moja kwa moja au bonyeza +/- (You can type directly or use +/-)
            </p>
        </div>

        <!-- Reminder Toggle -->
        <div class="ap-remind-card">
            <div class="ap-remind-left">
                <div class="ap-remind-icon">
                    <span class="material-symbols-outlined">notifications_active</span>
                </div>
                <div>
                    <p class="font-bold text-sm" style="font-weight:700;">Nikumbushe ikiisha</p>
                    <p class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter" style="font-size:10px; color:#9ca3af; font-weight:800;">Low stock reminder</p>
                </div>
            </div>
            <div class="ap-toggle" onclick="toggleNewReminder(this)">
                <div class="ap-toggle-dot"></div>
            </div>
        </div>

        <!-- Bottom Action Bar (Now inside container and static) -->
        <div class="ap-bottom-bar">
            <div class="ap-save-btn-wrapper">
                <button id="save-btn-idle" class="ap-save-btn" onclick="triggerMagicSave()">
                    <span class="material-symbols-outlined">save</span>
                    <span>Hifadhi Bidhaa</span>
                </button>
                
                <div id="save-btn-loading" class="ap-loading-state">
                    <span class="material-symbols-outlined magic-spin">auto_fix_high</span>
                </div>

                <div id="save-btn-success" class="ap-success-state">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="material-symbols-outlined" style="font-size:24px;">check_circle</span>
                        <span style="font-weight:900; letter-spacing:1px;">IMEFANIKIWA!</span>
                    </div>
                    <div class="confetti-particle" style="--tx: -40px; --ty: -60px; left: 20%; top: 40%;"></div>
                    <div class="confetti-particle" style="--tx: 50px; --ty: -80px; left: 70%; top: 30%;"></div>
                    <div class="confetti-particle" style="--tx: -80px; --ty: -40px; left: 10%; top: 60%;"></div>
                    <div class="confetti-particle" style="--tx: 90px; --ty: -20px; left: 85%; top: 50%;"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- =========================================
     REPLACED: STEP AI ASSISTANT (NEW DESIGN)
     ========================================= -->
<div id="step-ai" class="screen-wrapper hidden">
    <!-- Header -->
    <header id="ai-header">
        <div class="ai-header-left">
            <div class="ai-avatar-container">
                <div class="ai-avatar-img"></div>
                <div class="ai-status-dot"></div>
            </div>
            <div class="ai-header-text">
                <h1>Msaidizi wa AI</h1>
                <span class="ai-header-status">Yuko Tayari</span>
            </div>
        </div>
        <div class="ai-header-actions">
            <button class="ai-icon-btn">
                <span class="material-symbols-outlined" style="font-size: 20px;">search</span>
            </button>
            <button class="ai-icon-btn">
                <span class="material-symbols-outlined" style="font-size: 20px;">more_vert</span>
            </button>
        </div>
    </header>

    <!-- Main Chat Content -->
    <main id="ai-chat-stream">
        <div class="date-divider">
            <span class="date-pill">Leo</span>
        </div>

        <!-- CENTERED WELCOME STATE (Initially shown) -->
        <!-- Will be populated by JS -->
    </main>

    <!-- Bottom Fixed Input Area -->
    <div id="ai-bottom-container">
        <!-- Suggestion Chips -->
        <div class="suggestion-chips" id="ai-dashboard-view">
            <!-- Chips populated by JS -->
        </div>

        <!-- Input Bar -->
        <div class="input-bar-wrapper">
            <div class="ai-input-field-container">
                <input type="text" id="ai-chat-input" class="ai-chat-input-styled" placeholder="Andika hapa...">
                <button class="attach-btn">
                    <span class="material-symbols-outlined">attach_file</span>
                </button>
            </div>
            <button class="magic-send-btn" onclick="handleChatSubmit()">
                <span class="material-symbols-outlined" style="font-size: 24px;">magic_button</span>
            </button>
        </div>
    </div>
</div>

<!-- CUSTOMER STOREFRONT SCREEN -->
<div id="customer-storefront" class="screen-wrapper hidden" style="background: #fafafa;">
    <div class="app-container">
        <!-- Header -->
        <header class="customer-header">
            <div class="customer-header-logo">
                <div class="customer-logo-circle">
                    <span class="material-symbols-outlined">storefront</span>
                </div>
                <h1 class="customer-header-name" id="customer-store-name">Store</h1>
            </div>
            <button class="customer-whatsapp-btn" onclick="contactMerchantWhatsApp()">
                <span class="material-symbols-outlined">chat</span>
                Contact
            </button>
        </header>

        <div class="main-content">
            <!-- Hero Section -->
            <div class="customer-hero">
                <div class="hero-carousel-wrapper">
                    <div class="hero-slide active" style="background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&q=80&w=800');"></div>
                    <div class="hero-slide" style="background-image: url('https://images.unsplash.com/photo-1441986300917-64674bd600d8?auto=format&fit=crop&q=80&w=800');"></div>
                </div>
                <div class="hero-overlay"></div>
                
                <div class="customer-hero-content">
                    <div class="customer-store-logo">
                        <span class="material-symbols-outlined">storefront</span>
                    </div>
                    <h1 class="customer-store-name" id="customer-hero-store-name">Welcome</h1>
                    <div class="customer-welcome-message">
                        <span class="customer-typewriter-text" id="customer-typewriter"></span>
                        <span class="customer-cursor"></span>
                    </div>
                    <button class="customer-cta-btn" onclick="scrollToProducts()">
                        Browse Products
                    </button>
                </div>
            </div>

            <!-- Products Section -->
            <div class="modern-products-container" id="customer-products-section">
                <h2 class="customer-section-title">Our Products</h2>
                <div class="modern-grid" id="customer-products-grid">
                    <!-- Products loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PRODUCT DETAIL PAGE -->
<div id="product-detail-page" class="screen-wrapper hidden">
    <div class="product-detail-container">
        <nav class="product-nav-bar">
            <button class="product-back-btn" onclick="closeProductDetail()">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div class="product-nav-actions">
                <button class="product-action-btn">
                    <span class="material-symbols-outlined">share</span>
                </button>
            </div>
        </nav>

        <div class="product-detail-scroll">
            <div class="product-image-gallery">
                <div class="product-main-image" id="product-detail-image">
                    <div class="image-indicators">
                        <div class="indicator active"></div>
                    </div>
                </div>
            </div>

            <div class="product-info-section">
                <h1 class="product-detail-title" id="product-detail-title">Product Name</h1>
                <div class="product-price-rating">
                    <p class="product-detail-price" id="product-detail-price">Tsh 0</p>
                </div>
                <p class="product-description" id="product-detail-description">Description</p>
            </div>

            <div class="product-stock-section">
                <h3 class="section-title">Availability</h3>
                <div class="stock-status-card" id="product-stock-status">
                    <span class="material-symbols-outlined stock-icon">inventory</span>
                    <span class="stock-text">In Stock</span>
                </div>
            </div>

            <div class="product-usage-section hidden" id="product-usage-section">
                <h3 class="section-title">Usage Instructions</h3>
                <div class="usage-card">
                    <span class="material-symbols-outlined usage-icon">medication</span>
                    <p class="usage-text" id="product-usage-text">Usage info</p>
                </div>
            </div>
        </div>

        <div class="product-bottom-bar">
            <button class="whatsapp-order-btn" onclick="orderProductViaWhatsApp()">
                <span class="material-symbols-outlined" style="color: white; font-size: 24px;">chat</span>
            </button>
            <button class="add-to-cart-btn" onclick="orderProductViaWhatsApp()">
                <span class="material-symbols-outlined">shopping_cart</span>
                Order via WhatsApp
            </button>
        </div>
    </div>
</div>

<!--  ANIMATED SHARE MODAL -->
<div id="share-modal" class="hidden" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    animation: fadeIn 0.3s ease;
" onclick="closeShareModal(event)">
    <div class="share-modal-content" style="
        background: white;
        border-radius: 24px 24px 0 0;
        padding: 32px 24px;
        width: 100%;
        max-width: 500px;
        animation: slideUp 0.3s ease;
    " onclick="event.stopPropagation()">
        <div style="text-align: center; margin-bottom: 24px;">
            <h2 style="font-size: 20px; font-weight: 800; color: #1f2937; margin-bottom: 8px;">Share Your Store</h2>
            <p style="font-size: 14px; color: #6b7280;">Choose where to share your link</p>
        </div>
        
        <div class="share-options-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <button onclick="shareToWhatsApp()" class="share-option-btn" style="
                background: linear-gradient(135deg, #25D366, #128C7E);
                color: white;
                border: none;
                border-radius: 16px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            ">
                <span style="font-size: 32px;"></span>
                <span style="font-weight: 700; font-size: 14px;">WhatsApp</span>
            </button>
            
            <button onclick="shareToFacebook()" class="share-option-btn" style="
                background: linear-gradient(135deg, #1877F2, #0e5bb5);
                color: white;
                border: none;
                border-radius: 16px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            ">
                <span style="font-size: 32px;"></span>
                <span style="font-weight: 700; font-size: 14px;">Facebook</span>
            </button>
            
            <button onclick="shareToTwitter()" class="share-option-btn" style="
                background: linear-gradient(135deg, #1DA1F2, #0d8bd9);
                color: white;
                border: none;
                border-radius: 16px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            ">
                <span style="font-size: 32px;"></span>
                <span style="font-weight: 700; font-size: 14px;">Twitter</span>
            </button>
            
            <button onclick="shareToInstagram()" class="share-option-btn" style="
                background: linear-gradient(135deg, #E4405F, #C13584);
                color: white;
                border: none;
                border-radius: 16px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            ">
                <span style="font-size: 32px;"></span>
                <span style="font-weight: 700; font-size: 14px;">Instagram</span>
            </button>
        </div>
        
        <button onclick="copyLinkFromModal()" style="
            width: 100%;
            background: #f3f4f6;
            color: #1f2937;
            border: 2px solid #e5e7eb;
            border-radius: 50px;
            padding: 16px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            margin-bottom: 12px;
        ">
            <span class="material-symbols-outlined">content_copy</span>
            Copy Link
        </button>
        
        <button onclick="closeShareModal()" style="
            width: 100%;
            background: transparent;
            color: #6b7280;
            border: none;
            padding: 12px;
            font-weight: 700;
            cursor: pointer;
        ">
            Cancel
        </button>
    </div>
</div>

<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://vqgnxqabvmmpfoiceass.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZ254cWFidm1tcGZvaWNlYXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODE5NDMsImV4cCI6MjA3NDk1Nzk0M30.ZkOlMsqmfv4gCl3YG5CLe7te5DoIbZad8Y2mIpKTleA';
    
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE MANAGEMENT ---
    let CURRENT_BUSINESS_ID = localStorage.getItem('biashara_business_id');
    let GLOBAL_PRODUCTS = []; // To store products for AI context
    
    // Auth State
    let isSignup = false;
    const authTexts = ["Karibu. Tulikumiss sana ", "Karibu. Piga kazi leo ", "Karibu. maokoto yaendelee "];
    let textIdx = 0;
    
    // Add Product Draft State
    let draftProduct = {
        name: '',
        category: '',
        imageFiles: [], //  CHANGED: Array of images
        description: '',
        fullDescription: '', //  NEW: Detailed description
        price: 0,
        stock: 0,
        cost: 0,
        customCat: '',
        customColors: '',
        keywords: '',
        reminderEnabled: true,
        reminderCount: 5,
        usage: '',
        //  NEW PRODUCT ATTRIBUTES
        variants: {
            colors: [],
            sizes: [],
            materials: []
        },
        offers: {
            hasDiscount: false,
            originalPrice: 0,
            discountPercent: 0
        }
    };

    // Sale State
    let currentSaleItem = {
        id: null,
        price: 0,
        qty: 1,
        type: 'cash',
        stock: 0
    };

    // --- TRACKING HELPERS ---
    function trackSignup() {
      if(window.amp) amp.logEvent("Signup Completed");
    }

    function trackAddProduct(productName, price) {
      if(window.amp) {
          amp.logEvent("Product Added", {
            product_name: productName,
            price: price
          });
      }
    }

    function trackSale(productName, quantity, total) {
      if(window.amp) {
          amp.logEvent("Sale Recorded", {
            product_name: productName,
            quantity: quantity,
            total: total
          });
      }
    }

    function trackAIChat() {
      if(window.amp) amp.logEvent("AI Chat Used");
    }

    function trackSection(tabName) {
      if(window.amp) amp.logEvent("Section Opened", { section: tabName });
    }

    // --- INIT ---
    window.addEventListener('load', async () => {
        // Start Typewriter
        typewriterEffect();

        // ===================================================
        // CRITICAL: DETECT CUSTOMER vs MERCHANT MODE
        // ===================================================
        const urlParams = new URLSearchParams(window.location.search);
        const merchantId = urlParams.get('merchant'); // Legacy support
        const step = urlParams.get('step');
        
        //  NEW: Check for slug-based URL (e.g., /caceshop)
        const pathSlug = window.location.pathname.replace(/^\//, '').replace(/\/$/, '');
        
        // CUSTOMER MODE: Slug-based or legacy merchant ID
        if (pathSlug && pathSlug !== 'index.html' && pathSlug !== '') {
            console.log(' Customer Mode: Loading storefront from slug:', pathSlug);
            await loadCustomerStorefrontBySlug(pathSlug);
            return;
        } else if (merchantId) {
            console.log(' Customer Mode (Legacy): Loading storefront for merchant:', merchantId);
            await loadCustomerStorefront(merchantId);
            return;
        }

        // MERCHANT MODE: Authenticated dashboard access
        const { data: { session } } = await sb.auth.getSession();
        
        if(session) {
            // Logged in merchant
            if (step) {
                if (step === 'add-product') showScreen('step-add-product', false);
                else if (step === 'ai') showScreen('step-ai', false);
                else if (step === 'analytics') showScreen('step-analytics', false);
                else showScreen('step-' + step, false);
                if(step == 5 || step == 'ai') loadDashboard();
            } else {
                history.pushState({ step: 5 }, 'Dashboard', '?step=5');
                showScreen('step-5', false);
                loadDashboard();
            }
        } else {
            // Not logged in -> Show Auth
            showScreen('step-auth', true);
        }
    });

    // --- FIXED PWA INSTALL LOGIC ---
    let deferredPrompt;

    window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button on all relevant pages
        document.querySelectorAll(".pwa-install-card").forEach(el => {
            el.classList.remove("hidden");
            el.style.display = "flex";
        });
        
        console.log(" PWA install prompt ready");
    });

    // iOS Detection
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase());
    const isInStandaloneMode = () => 
        ('standalone' in window.navigator) && (window.navigator.standalone);

    // Show PWA button on iOS if not installed
    if (isIOS && !isInStandaloneMode()) {
        document.querySelectorAll(".pwa-install-card").forEach(el => {
            el.classList.remove("hidden");
            el.style.display = "flex";
        });
    }

    async function handlePWAClick() {
        console.log(" PWA Install clicked");
        
        // For Android/Desktop with native prompt
        if (deferredPrompt) {
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log(' User accepted PWA install');
                    // Hide install buttons after installation
                    document.querySelectorAll(".pwa-install-card").forEach(el => {
                        el.style.display = "none";
                    });
                } else {
                    console.log(' User dismissed PWA install');
                }
                
                deferredPrompt = null;
            } catch (error) {
                console.error("PWA install error:", error);
            }
            return;
        }
        
        // For iOS - Show manual instructions
        if (isIOS) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 24px;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 24px;
                    padding: 32px 24px;
                    max-width: 400px;
                    text-align: center;
                    animation: slideUp 0.3s ease;
                ">
                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                    <h3 style="font-size: 20px; font-weight: 800; color: #1f2937; margin-bottom: 16px;">
                        Pakua App (iOS)
                    </h3>
                    <div style="text-align: left; color: #4b5563; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
                        <p style="margin-bottom: 12px;"><strong>Hatua za kupakua:</strong></p>
                        <p style="margin-bottom: 8px;">1 Bonyeza alama ya <strong>Share</strong> () chini</p>
                        <p style="margin-bottom: 8px;">2 Chagua <strong>"Add to Home Screen"</strong></p>
                        <p style="margin-bottom: 8px;">3 Bonyeza <strong>"Add"</strong> kumaliza</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        width: 100%;
                        background: #22c55e;
                        color: white;
                        padding: 14px;
                        border-radius: 50px;
                        border: none;
                        font-size: 16px;
                        font-weight: 800;
                        cursor: pointer;
                    ">
                        Sawa, Nimeelewa
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            return;
        }
        
        // Fallback message for browsers without PWA support
        alert("Samahani, kivinjari chako hakiwezi kupakua app. Tafadhali tumia Chrome au Safari.");
    }

    // Show PWA button on page load if installable
    window.addEventListener('load', () => {
        const isInstalled = isInStandaloneMode() || window.matchMedia('(display-mode: standalone)').matches;
        
        if (!isInstalled) {
            document.querySelectorAll(".pwa-install-card").forEach(el => {
                el.classList.remove("hidden");
                el.style.display = "flex";
            });
        }
    });

    // --- AUTH LOGIC (EMAIL & GOOGLE) ---
    function toggleAuthMode(mode) {
        const loginTab = document.getElementById('tab-login');
        const signupTab = document.getElementById('tab-signup');
        const btnText = document.getElementById('auth-btn-text');
        const footerText = document.getElementById('auth-footer-text');
        const footerLink = document.getElementById('auth-footer-link');

        if(mode === 'signup') {
            isSignup = true;
            loginTab.classList.remove('active');
            signupTab.classList.add('active');
            btnText.innerText = 'Jisajili (Sign Up)';
            footerText.innerText = 'Already have an account? ';
            footerLink.innerText = 'INGIA (LOGIN)';
            footerLink.setAttribute('onclick', "toggleAuthMode('login')");
        } else {
            isSignup = false;
            signupTab.classList.remove('active');
            loginTab.classList.add('active');
            btnText.innerText = 'Ingia (Login)';
            footerText.innerText = 'Don\'t have an account? ';
            footerLink.innerText = 'CREATE ONE';
            footerLink.setAttribute('onclick', "toggleAuthMode('signup')");
        }
    }

    function togglePassVisibility() {
        const input = document.getElementById('auth-pass');
        const icon = document.querySelector('.password-toggle');
        if(input.type === 'password') {
            input.type = 'text';
            icon.innerText = 'visibility';
        } else {
            input.type = 'password';
            icon.innerText = 'visibility_off';
        }
    }

    // Google Auth Handler
    async function handleGoogleAuth() {
        try {
            const { data, error } = await sb.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://linkamarket.co.tz',
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'consent',
                    },
                },
            });
            if (error) throw error;
        } catch (error) {
            alert("Google Login Error: " + error.message);
        }
    }

    // Email Auth Handler
    async function handleAuth() {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-pass').value;
        const btn = document.querySelector('.auth-submit-btn');
        
        if(!email || !password) return alert('Please fill in all fields');
        if(password.length < 6) return alert('Password must be at least 6 characters');

        btn.innerHTML = 'Subiri...';
        btn.disabled = true;

        let result;
        if(isSignup) {
            result = await sb.auth.signUp({ email, password });
        } else {
            result = await sb.auth.signInWithPassword({ email, password });
        }

        const { data, error } = result;

        if(error) {
            alert(error.message);
            btn.innerHTML = '<span id="auth-btn-text">' + (isSignup ? 'Jisajili (Sign Up)' : 'Ingia (Login)') + '</span>';
            btn.disabled = false;
        } else {
            if(data.session) {
                if(isSignup) trackSignup();
                history.pushState({ step: 5 }, 'Dashboard', '?step=5');
                showScreen('step-5', true);
                loadDashboard();
            } else if (isSignup && !data.session) {
                 trackSignup();
                 alert('Registration successful! Please check your email to confirm.');
                 toggleAuthMode('login');
                 btn.disabled = false;
                 btn.innerHTML = 'Ingia (Login)';
            }
        }
    }

    function typewriterEffect() {
        const el = document.getElementById('typewriter');
        if(!el) return;
        
        let text = authTexts[textIdx];
        let i = 0;
        let isDeleting = false;
        
        function type() {
            const currentText = authTexts[textIdx];
            if (isDeleting) {
                el.innerText = currentText.substring(0, i - 1);
                i--;
            } else {
                el.innerText = currentText.substring(0, i + 1);
                i++;
            }

            if (!isDeleting && i === currentText.length) {
                isDeleting = true;
                setTimeout(type, 2000); // Pause at end
            } else if (isDeleting && i === 0) {
                isDeleting = false;
                textIdx = (textIdx + 1) % authTexts.length;
                setTimeout(type, 500); // Pause before new text
            } else {
                setTimeout(type, isDeleting ? 50 : 100);
            }
        }
        type();
    }


    // --- NAVIGATION HELPERS ---
    function navigateTo(stepNum, title) {
        // Handle step feedback
        let btnId;
        if(typeof stepNum === 'string') btnId = 'btn-step-7'; // default guess
        else btnId = `btn-step-${stepNum-1}`;
        
        triggerFeedback(btnId);
        
        setTimeout(() => {
            if(typeof stepNum === 'string') {
                history.pushState({ step: stepNum }, title, `?step=${stepNum}`);
                showScreen('step-' + stepNum, true); // Generalize showing screen
            } else {
                history.pushState({ step: stepNum }, title, `?step=${stepNum}`);
                showScreen(`step-${stepNum}`, true);
            }
        }, 150);
    }
    
    function showScreen(stepId, animate) {
        ['step-auth', 'step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-add-product', 'step-11', 'step-ai', 'step-analytics', 'product-detail-page', 'customer-storefront', 'step-profile'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });
        const target = document.getElementById(stepId);
        if(target) {
            target.classList.remove('hidden');
            if (animate) {
                target.classList.remove('fade-in');
                void target.offsetWidth; 
                target.classList.add('fade-in');
            }
        }
    }
    
    function triggerFeedback(btnId) {
        const btn = document.getElementById(btnId);
        if(btn) {
            btn.classList.add('pressed');
            if (navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => btn.classList.remove('pressed'), 150);
        }
    }
    
    function goBack() { window.history.back(); }
    
    window.addEventListener('popstate', (event) => {
        const step = event.state ? event.state.step : 5; // Default to dash if authorized
        
        //  HANDLE PRODUCT DETAIL BACK NAVIGATION
        if (step === 'product-detail') {
            const productId = event.state?.productId;
            const from = event.state?.from;
            
            // Show product detail page (will be handled by existing logic)
            showScreen('product-detail-page', true);
            return;
        }

        // Simple logic for back button handling vs auth
        sb.auth.getSession().then(({data:{session}}) => {
             if(!session && step > 0 && step !== 'auth') showScreen('step-auth', true);
             else {
                 if (step === 'add-product') showScreen('step-add-product', true);
                 else if (step === 'ai') showScreen('step-ai', true);
                 else if (step === 'analytics') showScreen('step-analytics', true);
                 else if (step === 'product-detail-page') showScreen('product-detail-page', true);
                 else if (step === 'customer-storefront') showScreen('customer-storefront', true);
                 else showScreen(`step-${step || 5}`, true);
             }
        });
    });

    // --- ONBOARDING LOGIC ---
    function handleStep1Click() { navigateTo(2, 'Business Name'); }
    
    function handleStep2Click() {
        const name = document.getElementById('shop-name-input').value;
        if(!name) return alert('Please enter a name');
        localStorage.setItem('temp_shop_name', name);
        navigateTo(3, 'Category'); 
    }
    
    function selectCategory(element, name) { 
        document.querySelectorAll('.cat-card').forEach(card => card.classList.remove('selected')); 
        element.classList.add('selected'); 
        
        localStorage.setItem('temp_shop_cat', name);

        const otherInput = document.getElementById('other-input-container'); 
        if (name === 'Other') { 
            otherInput.classList.add('open'); 
            setTimeout(() => otherInput.querySelector('input').focus(), 100); 
        } else { 
            otherInput.classList.remove('open'); 
        } 
        if (navigator.vibrate) navigator.vibrate(20); 
    }

    function handleStep3Click() { 
        navigateTo(4, 'Shop Rules'); 
    }
    
    async function handleStep4Click() {
        triggerFeedback('btn-step-4');
        const shopName = localStorage.getItem('temp_shop_name');
        const shopCat = localStorage.getItem('temp_shop_cat');
        const phone = document.getElementById('whatsapp-input').value;
        const lipa = document.getElementById('lipa-input').value;

        // Simply redirect to dash, assuming auth user is set
        setTimeout(() => {
            history.pushState({ step: 5 }, 'Inventory', `?step=5`);
            showScreen('step-5', true);
            loadDashboard();
        }, 150);
    }

    // --- DASHBOARD LOGIC ---
    // FIXED: loadDashboard now handles navigation properly and modern UI
    async function loadDashboard() {
        trackSection("Dashboard");
        // Switch to dashboard screen
        history.pushState({ step: 5 }, 'Dashboard', '?step=5');
        showScreen('step-5', true);
        
        // Start Hero Typewriter
        typeWriterHero();
        
        // Update active nav state
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item')[0]?.classList.add('active'); // First item is home
        
        // Fetch and display data
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        // 1. Fetch Profile Info
        const { data: profile } = await sb
            .from('profiles')
            .select('business_name, whatsapp_number')
            .eq('id', user.id)
            .single();

        // 2. Update Header Name
        if(profile && profile.business_name) {
            document.getElementById('dash-business-name').innerText = profile.business_name.toUpperCase();
        }

        // 3. Show/Hide "Missing Info" Alert
        const alertCard = document.getElementById('setup-alert');
        if(!profile || !profile.whatsapp_number || !profile.business_name) {
            alertCard.classList.remove('hidden');
        } else {
            alertCard.classList.add('hidden');
        }

        // 4. Fetch Products for Modern Grid
        const { data: products, error } = await sb
            .from('products')
            .select(`
                *,
                product_images(image_url)
            `)
            .eq('merchant_id', user.id)
            .eq('is_active', true)      
            .order('created_at', { ascending: false });

        GLOBAL_PRODUCTS = products || []; // Save for AI Context

        const container = document.getElementById('products-container');
        if(container) {
            container.innerHTML = '';

            if(products && products.length > 0) {
                products.forEach((p, index) => {
                    const img = getProductImage(p);
                    
                    // Logic for Stock Status Badge
                    let stockBadge = '';
                    if (p.total_stock === 0) stockBadge = '<span class="stock-badge-modern" style="color:red;">Out of Stock</span>';
                    else if (p.total_stock <= (p.low_stock_alert || 5)) stockBadge = `<span class="stock-badge-modern" style="color:orange;">Low Stock</span>`;

                    // REDESIGNED MODERN PRODUCT CARD HTML
                    // Added animation delay based on index for staggered effect
                    const html = `
                    <div class="modern-product-card" onclick="openProductDetailPage('${p.id}', '${p.name}', '${p.selling_price}', '${p.total_stock}', '${img}', '${p.description || ''}')" style="animation-delay: ${index * 0.1}s">
                        <div class="modern-img-wrapper">
                            <img src="${img}" class="modern-img">
                            ${stockBadge}
                        </div>
                        <div class="modern-details" style="padding: 12px;">
                            <h4 class="modern-title">${p.name}</h4>
                            <p class="modern-price">Tsh ${p.selling_price.toLocaleString()}</p>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            } else {
                container.innerHTML = `
                <div style="grid-column: 1/-1; padding:40px; text-align:center; color:#9ca3af; display:flex; flex-direction:column; align-items:center;">
                    <span class="material-symbols-outlined" style="font-size:48px; opacity:0.5; margin-bottom:10px;">storefront</span>
                    <p>Karibu! Duka lako liko wazi.</p>
                    <button onclick="goToAddProduct()" style="margin-top:10px; color:#25d078; font-weight:700; background:none; border:none; cursor:pointer;">Anza kuweka bidhaa &rarr;</button>
                </div>`;
            }
        }
    }
    
    // NEW: Hero Typewriter Function
    function typeWriterHero() {
        const text = "Weka oda yako, salama zaidi, chagua unachopenda.";
        const element = document.getElementById('hero-typewriter-text');
        if(!element) return;
        
        let i = 0;
        element.innerHTML = ""; // Clear existing
        
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, 50); // Speed of typing
            }
        }
        
        // Small delay before starting
        setTimeout(type, 500);
    }

    // --- NEW LOGIC FOR PROFILE & LINKS ---

    // 1. Open Profile Screen
    async function openProfileSettings() {
        // Hide other screens
        document.querySelectorAll('.screen-wrapper').forEach(el => el.classList.add('hidden'));
        document.getElementById('step-profile').classList.remove('hidden');
        
        // Load current data
        const { data: { user } } = await sb.auth.getUser();
        if(!user) return;

        const { data: profile } = await sb
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if(profile) {
            document.getElementById('prof-shop-name').value = profile.business_name || '';
            // Handle splitting phone number if needed, but for now just load it
            const fullPhone = profile.whatsapp_number || profile.phone_number || '';
            // Basic logic to separate country code if needed, but keeping simple for now
            document.getElementById('prof-phone').value = fullPhone.replace(/^\+25\d/, ''); 
            
            const initial = (profile.business_name || user.email).charAt(0).toUpperCase();
            document.getElementById('settings-avatar').innerText = initial;
            
            updateLinkPreview(profile.business_name);
        }
    }

    // 2. Dynamic Link Preview
    function updateLinkPreview(val) {
        const name = val || document.getElementById('prof-shop-name').value;
        
        if (!name) {
            document.getElementById('prof-link-preview').innerText = 'Enter a shop name first';
            return;
        }
        
        // Generate clean slug
        const slug = name
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '') // Remove special chars
            .replace(/\s+/g, '-') // Spaces to hyphens
            .replace(/-+/g, '-') // Multiple hyphens to single
            .substring(0, 50); // Max 50 chars
        
        const baseUrl = window.location.origin;
        document.getElementById('prof-link-preview').innerText = `${baseUrl}/${slug}`;
    }

    // 3. Save Profile
    async function saveShopProfile() {
        const btn = document.querySelector('.save-profile-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Saving...';
        btn.disabled = true;

        const name = document.getElementById('prof-shop-name').value.trim();
        const countryCode = document.getElementById('country-code-select').value;
        const phoneNumber = document.getElementById('prof-phone').value.trim();
        const phone = countryCode + phoneNumber.replace(/^0+/, ''); // Remove leading zeros

        if (!name) {
             alert("Please enter a Shop Name.");
             btn.innerHTML = originalText;
             btn.disabled = false;
             return;
        }

        if (!phoneNumber || phoneNumber.length < 9) {
            alert("Please enter a valid phone number (at least 9 digits).");
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        // Generate slug
        const slug = name
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .substring(0, 50);

        const { data: { user } } = await sb.auth.getUser();

        // Check if slug is taken
        const { data: existingSlug } = await sb
            .from('profiles')
            .select('id')
            .eq('store_slug', slug)
            .neq('id', user.id)
            .single();

        if (existingSlug) {
            alert(`The store name "${name}" is already taken. Please choose another name.`);
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        // Update Supabase
        const { error } = await sb
            .from('profiles')
            .update({ 
                business_name: name,
                whatsapp_number: phone,
                phone_number: phone,
                store_slug: slug //  Save slug
            })
            .eq('id', user.id);

        if(error) {
            alert("Error saving: " + error.message);
        } else {
            alert("Profile updated successfully! Your store link is now active.");
            loadDashboard();
        }
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    }

    // 5. Updated "Copy Link" Logic
    async function copyStorefrontLink() {
        //  SHOW SHARE MODAL INSTEAD OF DIRECT COPY
        const modal = document.getElementById('share-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }

    //  NEW: Helper function to get Store URL consistently
    async function getStoreUrl() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return window.location.origin; // Fallback
        
        const { data: profile } = await sb
            .from('profiles')
            .select('store_slug')
            .eq('id', user.id)
            .single();
        
        const origin = window.location.origin;
        return profile?.store_slug 
            ? `${origin}/${profile.store_slug}` 
            : `${origin}?merchant=${user.id}`;
    }

    //  NEW: Close Share Modal
    function closeShareModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('share-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }

    //  NEW: Copy Link from Modal
    async function copyLinkFromModal() {
        try {
            const storeUrl = await getStoreUrl();
            await navigator.clipboard.writeText(storeUrl);
            
            // Show success message
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 20px 32px;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
                z-index: 10000;
                font-weight: 700;
                text-align: center;
                animation: popIn 0.3s ease;
            `;
            msg.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                <div>Link Copied!</div>
            `;
            document.body.appendChild(msg);
            
            setTimeout(() => msg.remove(), 2000);
            closeShareModal();
            
        } catch (err) {
            const storeUrl = await getStoreUrl();
            prompt('Copy this link:', storeUrl);
        }
    }

    //  NEW: Share to WhatsApp
    async function shareToWhatsApp() {
        const storeUrl = await getStoreUrl();
        const text = `Check out my store:\n${storeUrl}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        closeShareModal();
    }

    //  NEW: Share to Facebook
    async function shareToFacebook() {
        const storeUrl = await getStoreUrl();
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(storeUrl)}`, '_blank');
        closeShareModal();
    }

    //  NEW: Share to Twitter
    async function shareToTwitter() {
        const storeUrl = await getStoreUrl();
        const text = `Check out my store!`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(storeUrl)}`, '_blank');
        closeShareModal();
    }

    //  NEW: Share to Instagram (Copy link + show instructions)
    async function shareToInstagram() {
        await copyLinkFromModal();
        alert('Link copied! Open Instagram and paste it in your bio or story ');
    }

    // ADDED: Navigation to Sales Analytics Page
    function goToAnalytics() {
        trackSection("Mauzo");
        history.pushState({ step: 'analytics' }, 'Sales Analytics', '?step=analytics');
        showScreen('step-analytics', true);
        loadAnalytics('today'); // Load default 'today'
    }

    // ADDED: Load Analytics Data Logic
    async function loadAnalytics(range, tabElement) {
        // UI: Tab Switching
        if(tabElement) {
            document.querySelectorAll('.ana-tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
        }

        const { data: { user } } = await sb.auth.getUser();
        if(!user) return;

        // Populate User Info on Analytics Page
        const name = user.user_metadata?.name || user.email;
        const initial = name ? name.charAt(0).toUpperCase() : '?';
        document.getElementById('ana-business-name').innerText = name.split('@')[0];
        const ava = document.getElementById('ana-profile-avatar');
        ava.style.width = '45px'; ava.style.height = '45px'; ava.style.borderRadius = '50%';
        ava.style.background = '#22c55e'; ava.style.display='flex'; ava.style.alignItems='center';
        ava.style.justifyContent='center'; ava.style.color='white'; ava.style.fontWeight='800';
        ava.innerText = initial;

        // Date Logic
        const now = new Date();
        let startDate = new Date();
        
        if (range === 'week') {
            const day = now.getDay() || 7; 
            if(day !== 1) startDate.setHours(-24 * (day - 1));
            else startDate.setHours(0,0,0,0);
        } else if (range === 'month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        } else {
            // Today
            startDate.setHours(0,0,0,0);
        }

        const startStr = startDate.toISOString();

        // Fetch Sales (Cash)
        const { data: salesData } = await sb
            .from('sales')
            .select('total_amount, created_at, product_id, products(name)')
            .eq('merchant_id', user.id)
            .eq('payment_type', 'cash')
            .gte('created_at', startStr)
            .order('created_at', { ascending: false });

        // Fetch Debts (All created in range, even if paid later, usually implies credit sales)
        // Simplified: Show debts created in this range.
        const { data: debtData } = await sb
            .from('debts')
            .select('total_amount, created_at, debtor_name')
            .eq('merchant_id', user.id)
            .gte('created_at', startStr)
            .order('created_at', { ascending: false });

        let totalSales = 0;
        let totalDebt = 0;

        const allTransactions = [];

        if (salesData) {
            salesData.forEach(s => {
                totalSales += s.total_amount;
                allTransactions.push({
                    type: 'sale',
                    name: s.products?.name || 'Bidhaa',
                    amount: s.total_amount,
                    time: new Date(s.created_at),
                    label: 'Cash'
                });
            });
        }

        if (debtData) {
            debtData.forEach(d => {
                totalDebt += d.total_amount;
                allTransactions.push({
                    type: 'debt',
                    name: 'Deni la ' + d.debtor_name.split(' ')[0],
                    amount: d.total_amount,
                    time: new Date(d.created_at),
                    label: 'Inadaiwa'
                });
            });
        }

        // Sort combined list
        allTransactions.sort((a,b) => b.time - a.time);

        // Update UI
        // Note: Profit usually = Sales - Cost. Since we don't have cost reliably, we display Revenue as "Faida/Sales" based on screenshot layout.
        document.getElementById('ana-total-profit').innerText = (totalSales + totalDebt).toLocaleString() + ' TZS'; 
        document.getElementById('ana-sales-val').innerText = totalSales.toLocaleString() + ' TZS';
        document.getElementById('ana-debt-val').innerText = totalDebt.toLocaleString() + ' TZS';

        // Render List
        const listContainer = document.getElementById('ana-list-container');
        listContainer.innerHTML = '';

        if(allTransactions.length === 0) {
            listContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#9ca3af; display:flex; flex-direction:column; align-items:center;">Hakuna data kwa muda huu.</p>';
        } else {
            allTransactions.forEach(t => {
                const isSale = t.type === 'sale';
                const iconClass = isSale ? 'ali-ic-green' : 'ali-ic-orange';
                const icon = isSale ? 'checkroom' : 'person';
                const amountClass = isSale ? 'pos' : 'neg'; // Green for sales, Orange for debt creation
                const amountSign = '+'; // Both add to "volume"
                const badgeClass = isSale ? '' : 'debt';
                
                // Format time: "Saa 4:30 Asubuhi"
                const hours = t.time.getHours();
                const minutes = t.time.getMinutes().toString().padStart(2, '0');
                const period = hours < 12 ? 'Asubuhi' : (hours < 16 ? 'Mchana' : (hours < 19 ? 'Jioni' : 'Usiku'));
                const timeStr = `Saa ${hours}:${minutes} ${period}`;

                const html = `
                <div class="ana-list-item">
                    <div class="ali-left">
                        <div class="ali-icon-circle ${iconClass}">
                            <span class="material-symbols-outlined">${icon}</span>
                        </div>
                        <div class="ali-info">
                            <h4>${t.name}</h4>
                            <p>${timeStr}</p>
                        </div>
                    </div>
                    <div class="ali-right">
                        <span class="ali-amount ${amountClass}">${amountSign}${t.amount.toLocaleString()}</span>
                        <span class="ali-badge ${badgeClass}">${t.label}</span>
                    </div>
                </div>`;
                listContainer.innerHTML += html;
            });
        }
    }


    function getProductImage(product) {
        if (product.image_path) {
            const { data } = sb.storage.from('post-images').getPublicUrl(product.image_path);
            return data.publicUrl;
        }
        if (product.product_images && product.product_images.length > 0) {
            return product.product_images[0].image_url;
        }
        return 'https://via.placeholder.com/150';
    }

    // --- ADD PRODUCT LOGIC (NEW SINGLE PAGE) ---
    function goToAddProduct() {
        trackSection("Add Product");
        // Initialize State
        draftProduct = {
            name: '',
            category: '',
            imageFiles: [], //  CHANGED: Array of images
            description: '',
            fullDescription: '', //  NEW: Detailed description
            price: 0,
            stock: 1, // Default 1
            cost: 0,
            customCat: '',
            customColors: '',
            keywords: '',
            reminderEnabled: true,
            reminderCount: 5,
            usage: '',
            //  NEW PRODUCT ATTRIBUTES
            variants: {
                colors: [],
                sizes: [],
                materials: []
            },
            offers: {
                hasDiscount: false,
                originalPrice: 0,
                discountPercent: 0
            }
        };

        // Reset UI Inputs
        document.getElementById('new-prod-name').value = '';
        document.getElementById('new-prod-usage').value = ''; 
        document.getElementById('new-prod-full-desc').value = ''; // Reset full desc
        document.getElementById('new-prod-cost').value = '';
        document.getElementById('new-prod-price').value = '';
        document.getElementById('custom-color-input').value = '';
        document.getElementById('has-discount-check').checked = false;
        document.getElementById('discount-inputs').classList.add('hidden');
        document.getElementById('original-price-input').value = '';
        document.getElementById('discount-percent-input').value = '';
        
        // Reset Variant Chips
        document.querySelectorAll('.variant-chip').forEach(c => c.classList.remove('active'));

        // FIXED: Reset stock input
        const stockInput = document.getElementById('new-stock-input');
        if(stockInput) stockInput.value = '1';
        
        // Reset Photo Placeholder
        const previewImg = document.getElementById('ap-preview-img');
        const emptyState = document.getElementById('ap-photo-empty');
        const previewState = document.getElementById('ap-photo-preview');
        
        previewImg.src = "";
        previewState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        
        // Remove counter badge if exists
        const oldBadge = previewState.querySelector('.image-counter-badge');
        if(oldBadge) oldBadge.remove();

        // Reset Category Chips
        document.querySelectorAll('.ap-cat-chip').forEach(c => c.classList.remove('active'));

        // Reset Toggle
        document.querySelector('.ap-toggle').classList.remove('off');
        
        // Reset Save Button
        document.getElementById('save-btn-idle').classList.remove('hidden');
        document.getElementById('save-btn-loading').classList.remove('flex');
        document.getElementById('save-btn-loading').classList.add('hidden');
        document.getElementById('save-btn-success').classList.remove('flex');
        document.getElementById('save-btn-success').classList.add('hidden');

        // Show Screen
        history.pushState({ step: 'add-product' }, 'Add Product', '?step=add-product');
        showScreen('step-add-product', true);
    }

    function closeAddProduct() {
        history.pushState({ step: 5 }, 'Dashboard', '?step=5');
        showScreen('step-5', true);
        loadDashboard();
    }

    function triggerCamera() { document.getElementById('camera-input').click(); }
    
    function triggerGallery() { document.getElementById('gallery-input').click(); }
    
    function resetPhoto() {
        draftProduct.imageFiles = [];
        document.getElementById('camera-input').value = "";
        document.getElementById('gallery-input').value = "";
        
        document.getElementById('ap-photo-preview').classList.add('hidden');
        document.getElementById('ap-photo-empty').classList.remove('hidden');
        
        // Reset badge text
        const badge = document.querySelector('.ap-important-badge');
        if (badge) {
            badge.innerText = 'MUHIMU';
            badge.style.background = '#25d078';
        }
    }

    function handleImageUpload(input) {
        // Fallback for single image (Camera)
        if (input.files && input.files[0]) {
            const file = input.files[0];
             if (file.size > 500 * 1024) {
                compressImage(file, (compressedFile) => {
                    draftProduct.imageFiles = [compressedFile];
                    displayImage(compressedFile);
                });
            } else {
                draftProduct.imageFiles = [file];
                displayImage(file);
            }
        }
    }

    //  NEW: Handle Multiple Image Upload
    function handleMultipleImageUpload(input) {
        if (input.files && input.files.length > 0) {
            const files = Array.from(input.files).slice(0, 5); // Max 5 images
            
            draftProduct.imageFiles = [];
            
            files.forEach((file, index) => {
                if (file.size > 500 * 1024) {
                    compressImage(file, (compressedFile) => {
                        draftProduct.imageFiles.push(compressedFile);
                        if (index === 0) displayImage(compressedFile);
                        updateImagePreviewGallery();
                    });
                } else {
                    draftProduct.imageFiles.push(file);
                    if (index === 0) displayImage(file);
                    updateImagePreviewGallery();
                }
            });
            
            // Show success message
            const badge = document.querySelector('.ap-important-badge');
            if (badge) {
                const originalText = badge.innerText;
                badge.innerText = `${files.length} PICHA`;
                badge.style.background = '#10b981';
                setTimeout(() => {
                    badge.innerText = originalText;
                    badge.style.background = '#25d078';
                }, 2000);
            }
        }
    }

    //  NEW: Update image gallery preview
    function updateImagePreviewGallery() {
        if (draftProduct.imageFiles.length === 0) return;
        
        const previewContainer = document.getElementById('ap-photo-preview');
        if (!previewContainer) return;
        
        // Add image counter badge
        let counterBadge = previewContainer.querySelector('.image-counter-badge');
        if (!counterBadge && draftProduct.imageFiles.length > 1) {
            counterBadge = document.createElement('div');
            counterBadge.className = 'image-counter-badge';
            counterBadge.style.cssText = `
                position: absolute;
                top: 12px;
                left: 12px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 700;
                z-index: 30;
            `;
            previewContainer.appendChild(counterBadge);
        }
        
        if (counterBadge) {
            counterBadge.innerText = `${draftProduct.imageFiles.length} Images`;
        }
    }

    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Max dimensions: 800x800
                const maxDim = 800;
                if (width > height && width > maxDim) {
                    height *= maxDim / width;
                    width = maxDim;
                } else if (height > maxDim) {
                    width *= maxDim / height;
                    height = maxDim;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    callback(compressedFile);
                }, 'image/jpeg', 0.7); // 70% quality
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function displayImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('ap-preview-img');
            img.src = e.target.result;
            
            document.getElementById('ap-photo-empty').classList.add('hidden');
            document.getElementById('ap-photo-preview').classList.remove('hidden');
        }
        reader.readAsDataURL(file);
    }
    
    function selectNewCategory(btn, cat) {
        document.querySelectorAll('.ap-cat-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        draftProduct.category = cat;
    }

    function updateNewStock(val) {
        const stockInput = document.getElementById('new-stock-input');
        if (!stockInput) return;
        
        let current = parseInt(stockInput.value) || 0;
        current += val;
        if(current < 0) current = 0;
        
        stockInput.value = current;
        draftProduct.stock = current;
    }

    // ADDED: Sync stock value when user types directly
    function syncStockValue(value) {
        const numValue = parseInt(value) || 0;
        draftProduct.stock = numValue >= 0 ? numValue : 0;
    }

    function toggleNewReminder(el) {
        el.classList.toggle('off');
        draftProduct.reminderEnabled = !el.classList.contains('off');
    }

    //  NEW: Toggle Variant Selection
    function toggleVariantChip(element, type, value) {
        element.classList.toggle('active');
        
        if (element.classList.contains('active')) {
            draftProduct.variants[type + 's'].push(value);
        } else {
            const index = draftProduct.variants[type + 's'].indexOf(value);
            if (index > -1) {
                draftProduct.variants[type + 's'].splice(index, 1);
            }
        }
    }

    //  NEW: Toggle Discount Section
    function toggleDiscountSection() {
        const checkbox = document.getElementById('has-discount-check');
        const inputs = document.getElementById('discount-inputs');
        
        if (checkbox.checked) {
            inputs.classList.remove('hidden');
            inputs.style.display = 'grid';
            draftProduct.offers.hasDiscount = true;
        } else {
            inputs.classList.add('hidden');
            inputs.style.display = 'none';
            draftProduct.offers.hasDiscount = false;
        }
    }

    async function triggerMagicSave() {
        // Collect Data
        draftProduct.name = document.getElementById('new-prod-name').value.trim();
        draftProduct.usage = document.getElementById('new-prod-usage').value.trim(); // ADDED
        draftProduct.fullDescription = document.getElementById('new-prod-full-desc')?.value.trim() || ''; //  NEW
        draftProduct.cost = parseInt(document.getElementById('new-prod-cost').value) || 0;
        draftProduct.price = parseInt(document.getElementById('new-prod-price').value) || 0;
        
        //  NEW: Collect discount data
        const hasDiscount = document.getElementById('has-discount-check')?.checked;
        if (hasDiscount) {
            draftProduct.offers.originalPrice = parseInt(document.getElementById('original-price-input')?.value) || 0;
            draftProduct.offers.discountPercent = parseInt(document.getElementById('discount-percent-input')?.value) || 0;
            draftProduct.offers.hasDiscount = true;
        }
        
        //  NEW: Collect custom color
        const customColor = document.getElementById('custom-color-input')?.value.trim();
        if (customColor && !draftProduct.variants.colors.includes(customColor)) {
            draftProduct.variants.colors.push(customColor);
        }

        // FIXED: Get stock from input field
        const stockInput = document.getElementById('new-stock-input');
        draftProduct.stock = stockInput ? (parseInt(stockInput.value) || 1) : 1;

        if(!draftProduct.name) return alert("Tafadhali weka jina la bidhaa");
        if(draftProduct.price <= 0) return alert("Tafadhali weka bei ya kuuza");

        const btnIdle = document.getElementById('save-btn-idle');
        const btnLoading = document.getElementById('save-btn-loading');
        const btnSuccess = document.getElementById('save-btn-success');

        // Animation: Loading
        btnIdle.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        btnLoading.classList.add('flex'); // to center content

        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
             alert("Login expired");
             return closeAddProduct();
        }

        try {
            //  Upload Multiple Images
            let imageFileNames = [];
            if(draftProduct.imageFiles && draftProduct.imageFiles.length > 0) {
                for (const file of draftProduct.imageFiles) {
                    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${file.name}`;
                    const { error: imgError } = await sb.storage
                        .from('post-images')
                        .upload(fileName, file);
                    if (!imgError) imageFileNames.push(fileName);
                }
            }

            //  Insert Product with new fields
            const { data: newProduct, error: prodError } = await sb
                .from('products')
                .insert([{
                    merchant_id: user.id,
                    name: draftProduct.name,
                    description: draftProduct.usage || draftProduct.fullDescription,
                    full_description: draftProduct.fullDescription, //  Store full description separately
                    selling_price: draftProduct.price,
                    original_price: draftProduct.offers.hasDiscount ? draftProduct.offers.originalPrice : null,
                    discount_percent: draftProduct.offers.hasDiscount ? draftProduct.offers.discountPercent : null,
                    total_stock: draftProduct.stock,
                    low_stock_alert: draftProduct.reminderEnabled ? 5 : 0,
                    image_path: imageFileNames[0] || null,
                    is_active: true,
                    //  Store variants as JSON
                    product_variants: JSON.stringify(draftProduct.variants)
                }])
                .select()
                .single();

            if(prodError) throw prodError;
            
            //  Insert additional images to product_images table if structure allows
            // Note: This assumes product_images table exists as per logic flow, if not it safely skips
            if (imageFileNames.length > 1 && newProduct) {
                try {
                     const imageRecords = imageFileNames.slice(1).map((fileName, index) => ({
                        product_id: newProduct.id,
                        image_url: sb.storage.from('post-images').getPublicUrl(fileName).data.publicUrl,
                        display_order: index + 1
                    }));
                    
                    // Attempt to insert if table exists
                    await sb.from('product_images').insert(imageRecords);
                } catch(e) { console.log("Product images table might not exist", e); }
            }

            // Track Success Event
            trackAddProduct(draftProduct.name, draftProduct.price);

            // Animation: Success
            setTimeout(() => {
                btnLoading.classList.add('hidden');
                btnLoading.classList.remove('flex');
                
                btnSuccess.classList.remove('hidden');
                btnSuccess.classList.add('flex');

                // Redirect after success animation
                setTimeout(() => {
                    closeAddProduct();
                }, 2000);
            }, 1000); // Fake delay for smooth animation

        } catch (err) {
            console.error(err);
            alert('Error saving product: ' + err.message);
            // Reset button
            btnLoading.classList.add('hidden');
            btnLoading.classList.remove('flex');
            btnIdle.classList.remove('hidden');
        }
    }

    // --- RECORD SALE LOGIC ---
    function openRecordSale(id, name, price, stock, img) {
        currentSaleItem.id = id;
        currentSaleItem.price = Number(price);
        currentSaleItem.stock = Number(stock);
        currentSaleItem.qty = 1;
        currentSaleItem.type = 'cash';

        document.getElementById('rs-title').innerText = name;
        document.getElementById('rs-price').innerText = 'Tsh ' + currentSaleItem.price.toLocaleString();
        document.getElementById('rs-stock').innerText = stock;
        document.getElementById('rs-stock-sm').innerText = stock;
        document.getElementById('rs-img').src = img;
        
        toggleSaleType('cash');
        updateSaleUI();
        document.getElementById('step-11').classList.remove('hidden');
    }

    function closeRecordSale() {
        document.getElementById('step-11').classList.add('hidden');
    }

    function updateSaleQty(change) {
        const newQty = currentSaleItem.qty + change;
        if(newQty > 0 && newQty <= currentSaleItem.stock) {
            currentSaleItem.qty = newQty;
            updateSaleUI();
        }
    }
    
    function toggleSaleType(type) {
        currentSaleItem.type = type;
        document.getElementById('btn-type-cash').classList.toggle('active', type === 'cash');
        document.getElementById('btn-type-debt').classList.toggle('active', type === 'debt');

        // Added logic for debt input visibility
        const debtSection = document.getElementById('debt-info-section');
        if(debtSection) {
            if(type === 'debt') debtSection.classList.remove('hidden');
            else debtSection.classList.add('hidden');
        }
    }

    function updateSaleUI() {
        const total = currentSaleItem.price * currentSaleItem.qty;
        document.getElementById('rs-qty').innerText = currentSaleItem.qty;
        document.getElementById('rs-unit-price').innerText = currentSaleItem.price.toLocaleString();
        document.getElementById('rs-total-grid').innerText = total.toLocaleString();
        document.getElementById('rs-footer-total').innerText = total.toLocaleString();
    }
    
    // =========================================
    // FIXED: SALES VS DEBTS LOGIC
    // =========================================
    async function confirmTransaction() {
        const btn = document.querySelector('.confirm-sale-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Processing...";
        btn.disabled = true;

        try {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) throw new Error("Please login again");

            // Common: Update Product Stock First
            const newStock = currentSaleItem.stock - currentSaleItem.qty;
            const { error: stockError } = await sb
                .from('products')
                .update({ total_stock: newStock })
                .eq('id', currentSaleItem.id);

            if (stockError) throw stockError;

            // BRANCH: Cash Sale vs Debt
            if (currentSaleItem.type === 'debt') {
                //  INSERT INTO DEBTS TABLE
                const dName = document.getElementById('debtor-name').value.trim();
                const dPhone = document.getElementById('debtor-phone').value.trim();
                
                if (!dName) {
                    throw new Error("Tafadhali weka jina la mdaiwa (Please enter debtor name)");
                }

                const { error: debtError } = await sb.from('debts').insert([{
                    merchant_id: user.id,
                    product_id: currentSaleItem.id,
                    debtor_name: dName,
                    debtor_phone: dPhone || null,
                    quantity: currentSaleItem.qty,
                    unit_price: currentSaleItem.price,
                    total_amount: currentSaleItem.price * currentSaleItem.qty,
                    is_paid: false
                }]);

                if (debtError) throw debtError;

            } else {
                //  INSERT INTO SALES TABLE (CASH)
                const { error: salesError } = await sb
                    .from('sales')
                    .insert([{
                        merchant_id: user.id,
                        product_id: currentSaleItem.id,
                        quantity: currentSaleItem.qty,
                        unit_price: currentSaleItem.price,
                        total_amount: currentSaleItem.price * currentSaleItem.qty,
                        payment_type: 'cash'
                    }]);

                if (salesError) throw salesError;
            }

            // Track Sale Event
            const productName = document.getElementById('rs-title').innerText;
            const total = currentSaleItem.price * currentSaleItem.qty;
            trackSale(productName, currentSaleItem.qty, total);

            // Success: Close modal and refresh dashboard
            closeRecordSale();
            await loadDashboard();
            
            // Show success message
            alert(currentSaleItem.type === 'debt' ? 
                'Deni limerekodiwa! (Debt recorded!)' : 
                'Mauzo yamerekodiwa! (Sale recorded!)'
            );

        } catch (err) {
            console.error("Transaction Error:", err);
            alert("Error: " + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // =========================================
    // NEW: MARK DEBT AS PAID
    // =========================================
    async function markDebtAsPaid(debtId) {
        if (!confirm('Confirm debt has been paid?')) return;

        try {
            const { error } = await sb
                .from('debts')
                .update({ is_paid: true })
                .eq('id', debtId);

            if (error) throw error;

            await loadDashboard();
            alert('Debt marked as paid! ');
        } catch (err) {
            console.error('Error marking debt as paid:', err);
            alert('Error: ' + err.message);
        }
    }

    // =========================================
    // HELPER: TIME AGO FUNCTION
    // =========================================
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        const intervals = {
            year: 31536000,
            month: 2592000,
            week: 604800,
            day: 86400,
            hour: 3600,
            minute: 60
        };
        
        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
            }
        }
        
        return 'just now';
    }

    // --- AI ASSISTANT LOGIC ---
    // Improved AI Logic with Context Building and Better Error Handling

    async function callAIFunction(userMessage) {
        try {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) throw new Error("Tafadhali ingia tena (Please login first)");

            const { data: { user } } = await sb.auth.getUser();
            const merchantContext = await buildMerchantContext(user.id);
            
            const functionUrl = `${SUPABASE_URL}/functions/v1/ai-coach`;
            
            const response = await fetch(functionUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${session.access_token}`,
                    "apikey": SUPABASE_KEY
                },
                body: JSON.stringify({
                    message: userMessage,
                    merchantData: merchantContext
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`AI Error: ${response.status}`);
            }

            const data = await response.json();
            return data.response || "Samahani, sijapata jibu.";

        } catch (error) {
            console.error("AI Error:", error);
            
            if (error.message.includes("fetch")) {
                return "Hakuna mtandao. Angalia internet yako.";
            } else if (error.message.includes("401")) {
                return "Ingia tena (Session expired)";
            } else {
                return `Kuna tatizo: ${error.message}`;
            }
        }
    }

    async function buildMerchantContext(merchantId) {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayISO = today.toISOString();

            const [productsRes, salesTodayRes, debtsRes] = await Promise.all([
                sb.from('products')
                  .select('id, name, selling_price, total_stock, cost_price, low_stock_alert, created_at')
                  .eq('merchant_id', merchantId)
                  .eq('is_active', true),
                
                sb.from('sales')
                  .select('total_amount, quantity, unit_price, created_at, product_id, products(name)')
                  .eq('merchant_id', merchantId)
                  .eq('payment_type', 'cash')
                  .gte('created_at', todayISO),
                
                sb.from('debts')
                  .select('debtor_name, total_amount, quantity, created_at')
                  .eq('merchant_id', merchantId)
                  .eq('is_paid', false)
            ]);

            const products = productsRes.data || [];
            const salesToday = salesTodayRes.data || [];
            const debts = debtsRes.data || [];

            let totalRevenue = 0;
            let totalCost = 0;
            let itemsSold = 0;

            salesToday.forEach(sale => {
                totalRevenue += sale.total_amount;
                itemsSold += sale.quantity;
                
                const product = products.find(p => p.id === sale.product_id);
                if (product && product.cost_price) {
                    totalCost += (product.cost_price * sale.quantity);
                }
            });

            const netProfit = totalRevenue - totalCost;
            const totalDebt = debts.reduce((sum, d) => sum + d.total_amount, 0);

            const lowStock = products.filter(p => 
                p.total_stock <= (p.low_stock_alert || 5) && p.total_stock > 0
            );

            const outOfStock = products.filter(p => p.total_stock === 0);

            return {
                period: {
                    startDate: todayISO,
                    endDate: new Date().toISOString()
                },
                sales: salesToday.map(s => ({
                    product: s.products?.name || 'Unknown',
                    quantity: s.quantity,
                    price: s.unit_price,
                    cost: products.find(p => p.id === s.product_id)?.cost_price || 0,
                    date: s.created_at
                })),
                inventory: products.map(p => ({
                    product: p.name,
                    quantity: p.total_stock,
                    cost: p.cost_price || 0,
                    sellingPrice: p.selling_price
                })),
                debts: debts.map(d => ({
                    customerName: d.debtor_name,
                    amount: d.total_amount,
                    daysOverdue: Math.floor((new Date() - new Date(d.created_at)) / (1000 * 60 * 60 * 24)),
                    date: d.created_at
                })),
                summary: {
                    totalProducts: products.length,
                    totalRevenue: totalRevenue,
                    totalCost: totalCost,
                    netProfit: netProfit,
                    itemsSoldToday: itemsSold,
                    totalDebt: totalDebt,
                    lowStockCount: lowStock.length,
                    outOfStockCount: outOfStock.length
                }
            };

        } catch (error) {
            console.error("Context building error:", error);
            return {
                error: "Failed to fetch merchant data",
                summary: { totalProducts: 0, totalRevenue: 0 }
            };
        }
    }

    function goToAI() {
        trackSection("AI");
        history.pushState({ step: 'ai' }, 'AI Assistant', '?step=ai');
        showScreen('step-ai', true);
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navs = document.querySelectorAll('.nav-item');
        if(navs.length > 3) navs[3].classList.add('active');
        
        initializeAIChat();
    }

    async function initializeAIChat() {
        const stream = document.getElementById('ai-chat-stream');
        const { data: { user } } = await sb.auth.getUser();
        
        const name = user?.user_metadata?.name || user?.email || "User";
        
        stream.innerHTML = `
            <div class="date-divider">
                <span class="date-pill">Leo</span>
            </div>
            
            <!-- CENTERED WELCOME STATE -->
            <div id="welcome-state" style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 60px 24px;
                min-height: 300px;
            ">
                <div style="
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #25d078, #1ea35e);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 24px;
                    box-shadow: 0 10px 30px rgba(37, 208, 120, 0.3);
                ">
                    <span class="material-symbols-outlined" style="font-size: 40px; color: white;">auto_awesome</span>
                </div>
                
                <h2 style="
                    font-size: 24px;
                    font-weight: 700;
                    color: #0f1a14;
                    margin-bottom: 12px;
                ">Habari, ${name.split('@')[0]}!</h2>
                
                <p style="
                    font-size: 15px;
                    color: #6b7280;
                    line-height: 1.6;
                    max-width: 300px;
                ">Nikusaidie nini leo kuhusu biashara yako? Uliza chochote!</p>
            </div>
            
            <div id="ai-loader-container" class="ai-empty-state" style="display: none;">
                <div class="sparkle-container">
                    <div class="sparkle-wrapper">
                        <div class="star" style="width: 6px; height: 6px; top: 0; left: 0; animation-delay: 0.1s"></div>
                        <div class="star" style="width: 4px; height: 4px; top: 16px; left: 32px; animation-delay: 0.5s"></div>
                        <div class="star" style="width: 8px; height: 8px; top: 8px; left: 64px; animation-delay: 1.2s"></div>
                        <div class="star" style="width: 6px; height: 6px; top: 32px; left: 96px; animation-delay: 0.3s"></div>
                        <div class="star" style="width: 4px; height: 4px; top: 8px; left: 128px; animation-delay: 0.8s"></div>
                        <div class="star" style="width: 8px; height: 8px; top: 24px; left: 16px; animation-delay: 0.4s"></div>
                        
                        <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: #25d078; opacity: 0.4;">
                            <span class="material-symbols-outlined" style="font-size: 32px; animation: softPulse 2s infinite;">auto_awesome</span>
                        </div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <p class="ai-thinking-text">Msaidizi wako anafikiria...</p>
                    <p style="font-size: 10px; color: #9ca3af; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.1em;">Inachambua data zako</p>
                </div>
            </div>
        `;
        
        updateAISuggestions();
    }

    function typeWriterEffect(text, elementId, speed = 50) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let i = 0;
        element.textContent = "";
        
        const cursor = element.nextElementSibling;
        if (cursor) cursor.style.display = "inline";
        
        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(type, speed);
                scrollToBottomAI();
            } else {
                if (cursor) {
                    setTimeout(() => {
                        cursor.style.display = "none";
                    }, 500);
                }
            }
        }
        
        type();
    }

    async function updateAISuggestions() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        const context = await buildMerchantContext(user.id);
        const chipsContainer = document.querySelector('.suggestion-chips');
        
        if (!chipsContainer) return;
        
        let suggestions = [];
        
        if (context.summary.netProfit > 0) {
            suggestions.push({
                icon: 'trending_up',
                text: 'Biashara inaendeleaje?',
                prompt: 'Niambie jinsi biashara yangu inavyoendelea leo. Je, niko na faida au hasara?'
            });
        } else if (context.summary.netProfit < 0) {
            suggestions.push({
                icon: 'trending_down',
                text: 'Kwa nini hasara?',
                prompt: 'Nichambue kwa nini niko na hasara leo na nifanye nini kuboresha?'
            });
        } else {
            suggestions.push({
                icon: 'monitoring',
                text: 'Biashara inaendeleaje?',
                prompt: 'Niambie jinsi biashara yangu inavyoendelea leo.'
            });
        }
        
        if (context.summary.totalDebt > 0) {
            suggestions.push({
                icon: 'message',
                text: 'WhatsApp kwa wadeni',
                prompt: 'Nitengenezee ujumbe wa WhatsApp wa kukumbushia wadeni wangu madeni yao.'
            });
        }
        
        if (context.summary.lowStockCount > 0 || context.summary.outOfStockCount > 0) {
            suggestions.push({
                icon: 'inventory_2',
                text: 'Bidhaa zinazoisha',
                prompt: 'Ni bidhaa zipi zinakaribia kuisha na nifanye nini?'
            });
        }

        suggestions.push({
            icon: 'lightbulb',
            text: 'Ushauri wa biashara',
            prompt: 'Nipe ushauri wa kuboresha biashara yangu kulingana na data yangu.'
        });

        chipsContainer.innerHTML = suggestions.map(s => `
            <button class="chip-btn chip-default" onclick="handleSmartChip(\`${s.prompt}\`, \`${s.text}\`, this)">
                <span class="material-symbols-outlined" style="font-size: 18px; color: #f78c26;">${s.icon}</span>
                <span>${s.text}</span>
            </button>
        `).join('');
    }

    async function handleSmartChip(prompt, displayText, btnElement) {
        trackAIChat();
        const welcomeState = document.getElementById('welcome-state');
        if (welcomeState) welcomeState.remove();
        
        appendUserMessage(displayText);
        showAILoading();
        
        const aiReply = await callAIFunction(prompt);
        removeAILoading();
        
        typewriterAppendAI(aiReply);
    }

    async function handleChatSubmit() {
        trackAIChat();
        const input = document.getElementById('ai-chat-input');
        const text = input.value.trim();
        if (!text) return;
        
        // Remove welcome state
        const welcomeState = document.getElementById('welcome-state');
        if (welcomeState) welcomeState.remove();
        
        input.value = "";
        input.disabled = true;
        
        appendUserMessage(text);
        showAILoading();
        
        try {
            const aiReply = await callAIFunction(text);
            removeAILoading();
            
            typewriterAppendAI(aiReply);
            
        } catch (error) {
            removeAILoading();
            typewriterAppendAI("Samahani, kuna tatizo. Jaribu tena.");
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    async function appendUserMessage(text) {
        const stream = document.getElementById('ai-chat-stream');
        const { data: { user } } = await sb.auth.getUser();
        
        if (!user) return;
        
        const name = user.user_metadata?.name || user.email || "User";
        const userAvatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=22c55e&color=fff&bold=true`;
        
        const row = document.createElement('div');
        row.className = 'chat-row user';
        
        row.innerHTML = `
            <div class="chat-avatar-small" style="background-image: url('${userAvatarUrl}'); background-size: cover;"></div>
            <div class="chat-content">
                <span class="chat-name">Wewe</span>
                <div class="chat-bubble user">
                    ${text}
                </div>
            </div>
        `;
        
        const loader = document.getElementById('ai-loader-container');
        stream.insertBefore(row, loader);
        
        scrollToBottomAI();
    }

    function typewriterAppendAI(text) {
        const stream = document.getElementById('ai-chat-stream');
        
        const row = document.createElement('div');
        row.className = 'chat-row';
        
        // Clean text formatting
        const cleanText = text.replace(/\n/g, '<br>');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanText;
        const plainText = tempDiv.textContent || tempDiv.innerText || "";
        
        row.innerHTML = `
            <div class="chat-avatar-small" style="
                background: linear-gradient(135deg, #25d078, #1ea35e);
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <span class="material-symbols-outlined" style="font-size: 18px; color: white;">smart_toy</span>
            </div>
            <div class="chat-content">
                <span class="chat-name">Msaidizi</span>
                <div class="chat-bubble ai-response">
                    <span class="typing-text"></span><span class="cursor">|</span>
                </div>
            </div>
        `;
        
        const loader = document.getElementById('ai-loader-container');
        stream.insertBefore(row, loader);
        
        const typingElement = row.querySelector('.typing-text');
        const cursorElement = row.querySelector('.cursor');
        
        let i = 0;
        const speed = 20;
        
        function typeChar() {
            if (i < plainText.length) {
                const char = plainText.charAt(i);
                
                if (char === '\n') {
                    typingElement.innerHTML += '<br>';
                } else {
                    typingElement.textContent += char;
                }
                
                i++;
                scrollToBottomAI();
                setTimeout(typeChar, speed);
            } else {
                cursorElement.style.display = 'none';
                typingElement.innerHTML = cleanText;
            }
        }
        
        typeChar();
    }

    function appendAIMessage(htmlContent) {
        const stream = document.getElementById('ai-chat-stream');
        
        const row = document.createElement('div');
        row.className = 'chat-row';
        
        row.innerHTML = `
            <div class="chat-avatar-small" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuAFfu5aXy6fVcu0ZGlstBgNMciJj4Iol1n38xmTWgNhpIoJ2vBMEUhVWfbVvhuiUbpVWgrzQ-DFMMnvkd48nZsfUBil8DJ3nzxdxEWN-065zefzzCTIl1FHz91Wpe9BOgrH0mVp4uCKpYwZw_TiHyijPAYC4MppP5dMjLrlwepwMGODPuDwJOrRi3U_D_OfJYhCI_pTNEdDZK0u2ySU-Pdh1QAK-QZQY5lpxYIV0wH3CawFjtRbvwp-XTOAzoBOOa_HRPst3Itmla4m');"></div>
            <div class="chat-content">
                <span class="chat-name">Msaidizi</span>
                <div class="chat-bubble ai">
                    ${htmlContent}
                </div>
            </div>
        `;
        
        const loader = document.getElementById('ai-loader-container');
        stream.insertBefore(row, loader);
        
        scrollToBottomAI();
    }

    function showAILoading() {
        const loader = document.getElementById('ai-loader-container');
        loader.style.display = 'flex';
        scrollToBottomAI();
    }

    function removeAILoading() {
        const loader = document.getElementById('ai-loader-container');
        loader.style.display = 'none';
    }

    function scrollToBottomAI() {
        const stream = document.getElementById('ai-chat-stream');
        setTimeout(() => {
            stream.scrollTo({
                top: stream.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }
    
    // Kept for overlay close button compatibility if overlay is ever used
    function closeAIResult() {
        // Function stub kept for backward compatibility
    }
    
    function handleAICardClick(type, btnElement) {
        // Fallback or backward compatible function
        const text = btnElement.innerText;
        handleSmartChip(text, text, btnElement);
    }

    // --- UI HELPERS ---
    function toggleChip(btn) { btn.classList.toggle('active'); if (navigator.vibrate) navigator.vibrate(20); }
    function selectVariantCat(el) { document.querySelectorAll('.cat-square').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); }
    function toggleSize(el) { el.classList.toggle('selected'); }
    function toggleColor(el) { el.classList.toggle('selected'); }
    
    // ADDED: Service Worker Registration
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then(reg => console.log("SW registered:", reg.scope))
            .catch(err => console.error("SW registration failed:", err));
        });
      }

    // Enable Enter key to send message
    document.addEventListener('DOMContentLoaded', () => {
        const chatInput = document.getElementById('ai-chat-input');
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleChatSubmit();
                }
            });
        }
    });

    // =======================================================
    // PRODUCT DETAIL PAGE FUNCTIONS
    // =======================================================

    let CURRENT_PRODUCT_DETAIL = null;

    // NEW FUNCTION: Open Product Detail Page
    function openProductDetailPage(id, name, price, stock, img, description) {
        CURRENT_PRODUCT_DETAIL = {
            id: id,
            name: name,
            price: Number(price),
            stock: Number(stock),
            image: img,
            description: description
        };
        
        //  ADD BROWSER HISTORY ENTRY
        const fromStorefront = document.getElementById('customer-storefront').classList.contains('hidden') === false;
        
        if (fromStorefront) {
            history.pushState({ 
                step: 'product-detail', 
                productId: id,
                from: 'storefront'
            }, `Product: ${name}`, `?product=${id}`);
        } else {
            history.pushState({ 
                step: 'product-detail', 
                productId: id,
                from: 'dashboard'
            }, `Product: ${name}`, `?product=${id}`);
        }
        
        // Update UI Elements
        document.getElementById('product-detail-title').textContent = name;
        document.getElementById('product-detail-price').textContent = `Tsh ${Number(price).toLocaleString()}`;
        
        // Update Image
        const imageEl = document.getElementById('product-detail-image');
        imageEl.style.backgroundImage = `linear-gradient(0deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0) 40%), url('${img}')`;
        
        // Update Description
        const descEl = document.getElementById('product-detail-description');
        descEl.textContent = description || 'High-quality product available for order.';
        
        // Update Stock Status
        const stockCard = document.getElementById('product-stock-status');
        const stockText = stockCard.querySelector('.stock-text');
        
        if (stock === 0) {
            stockCard.classList.add('out-of-stock');
            stockText.textContent = 'Out of Stock';
        } else if (stock <= 5) {
            stockCard.classList.remove('out-of-stock');
            stockText.textContent = `Only ${stock} left in stock`;
        } else {
            stockCard.classList.remove('out-of-stock');
            stockText.textContent = 'In Stock';
        }
        
        // Show/Hide Usage Section
        const usageSection = document.getElementById('product-usage-section');
        const usageText = document.getElementById('product-usage-text');
        
        if (description && description.toLowerCase().includes('mara')) {
            usageSection.classList.remove('hidden');
            usageText.textContent = description;
        } else {
            usageSection.classList.add('hidden');
        }

        //  Remove existing dynamic elements (variants and discount badges)
        const existingVariants = document.querySelector('.product-variants-section');
        if (existingVariants) existingVariants.remove();
        
        const existingDiscount = document.querySelector('.discount-badge-dynamic');
        if (existingDiscount) existingDiscount.remove();

        //  Fetch full product data with variants
        sb.from('products')
            .select('*')
            .eq('id', id)
            .single()
            .then(({ data: product, error }) => {
                if (error || !product) return;
                
                // Update full description
                descEl.textContent = product.full_description || product.description || 'High-quality product available for order.';
                
                //  Display variants
                const variants = product.product_variants || { colors: [], sizes: [], materials: [] };
                
                // Add variant section to product detail page
                const variantsContainer = document.createElement('div');
                variantsContainer.className = 'product-variants-section';
                variantsContainer.style.cssText = 'padding: 24px 16px; border-top: 1px solid #f1f5f9;';
                
                let variantsHTML = '';
                
                if (variants.colors && variants.colors.length > 0) {
                    variantsHTML += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; font-weight: 700; color: #1f2937; margin-bottom: 12px; text-transform:uppercase; letter-spacing:0.5px;">Available Colors</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${variants.colors.map(color => `
                                    <div style="
                                        padding: 8px 16px;
                                        background: #f8fafc;
                                        border: 1px solid #e2e8f0;
                                        border-radius: 50px;
                                        font-size: 13px;
                                        font-weight: 600;
                                        color: #4b5563;
                                    ">${color}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (variants.sizes && variants.sizes.length > 0) {
                    variantsHTML += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; font-weight: 700; color: #1f2937; margin-bottom: 12px; text-transform:uppercase; letter-spacing:0.5px;">Available Sizes</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${variants.sizes.map(size => `
                                    <div style="
                                        padding: 8px 16px;
                                        background: #f8fafc;
                                        border: 1px solid #e2e8f0;
                                        border-radius: 50px;
                                        font-size: 13px;
                                        font-weight: 600;
                                        color: #4b5563;
                                    ">${size}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (variants.materials && variants.materials.length > 0) {
                    variantsHTML += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; font-weight: 700; color: #1f2937; margin-bottom: 12px; text-transform:uppercase; letter-spacing:0.5px;">Material</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${variants.materials.map(material => `
                                    <div style="
                                        padding: 8px 16px;
                                        background: #f8fafc;
                                        border: 1px solid #e2e8f0;
                                        border-radius: 50px;
                                        font-size: 13px;
                                        font-weight: 600;
                                        color: #4b5563;
                                    ">${material}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                //  Show discount badge if applicable
                if (product.original_price && product.discount_percent) {
                    const discountBadge = document.createElement('div');
                    discountBadge.className = 'discount-badge-dynamic';
                    discountBadge.style.cssText = `
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                        padding: 6px 14px;
                        border-radius: 50px;
                        font-size: 12px;
                        font-weight: 800;
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                        z-index: 10;
                    `;
                    discountBadge.innerHTML = `-${product.discount_percent}% OFF`;
                    document.getElementById('product-detail-image').appendChild(discountBadge);
                    
                    // Update price display
                    const priceEl = document.getElementById('product-detail-price');
                    priceEl.innerHTML = `
                        <span style="text-decoration: line-through; color: #9ca3af; font-size: 18px; margin-right: 8px;">
                            Tsh ${product.original_price.toLocaleString()}
                        </span>
                        <span style="color: #ef4444;">Tsh ${product.selling_price.toLocaleString()}</span>
                    `;
                }
                
                // Inject Variants
                if (variantsHTML) {
                    variantsContainer.innerHTML = variantsHTML;
                    const stockSection = document.querySelector('.product-stock-section');
                    if (stockSection) {
                        stockSection.insertAdjacentElement('afterend', variantsContainer);
                    }
                }
            });
        
        // Show Product Detail Page
        showScreen('product-detail-page', true);
    }

    function closeProductDetail() {
        //  USE BROWSER BACK BUTTON
        window.history.back();
        CURRENT_PRODUCT_DETAIL = null;
    }

    async function orderProductViaWhatsApp() {
        if (!CURRENT_PRODUCT_DETAIL) return;
        
        let phone = '';
        
        // Check if customer is viewing a storefront (has merchantId)
        if (CURRENT_PRODUCT_DETAIL.merchantId) {
            // Customer mode: use stored merchant data
            if (!CURRENT_MERCHANT_DATA) {
                alert('Contact information not available');
                return;
            }
            phone = CURRENT_MERCHANT_DATA.whatsapp_number || CURRENT_MERCHANT_DATA.phone_number;
        } else {
            // Merchant mode: get own WhatsApp (shouldn't happen but fallback)
            const { data: { user } } = await sb.auth.getUser();
            if (!user) {
                alert('Please login to place an order');
                return;
            }
            
            const { data: merchantData } = await sb
                .from('profiles')
                .select('whatsapp_number, phone_number, business_name')
                .eq('id', user.id)
                .single();
            
            phone = merchantData?.whatsapp_number || merchantData?.phone_number || '';
        }
        
        if (!phone) {
            alert('Contact information not available. Please update your profile.');
            return;
        }
        
        // Create WhatsApp message
        const message = `Hi! I want to order:\n\n*${CURRENT_PRODUCT_DETAIL.name}*\nPrice: Tsh ${CURRENT_PRODUCT_DETAIL.price.toLocaleString()}\n\nPlease confirm availability.`;
        
        const whatsappUrl = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        
        // Track order attempt
        if (window.amp) {
            amp.logEvent("WhatsApp Order Initiated", {
                product_name: CURRENT_PRODUCT_DETAIL.name,
                price: CURRENT_PRODUCT_DETAIL.price
            });
        }
    }

    // =======================================================
    // CUSTOMER STOREFRONT FUNCTIONS (PUBLIC ACCESS)
    // =======================================================

    let CURRENT_MERCHANT_DATA = null;

    // =======================================================
    // NEW: LOAD STOREFRONT BY SLUG (e.g., /caceshop)
    // =======================================================
    async function loadCustomerStorefrontBySlug(slug) {
        console.log(' Looking up merchant by slug:', slug);
        
        try {
            // Find merchant by store_slug
            const { data: merchant, error: merchantError } = await sb
                .from('profiles')
                .select('id, business_name, whatsapp_number, phone_number')
                .eq('store_slug', slug.toLowerCase())
                .single();
            
            if (merchantError || !merchant) {
                console.error('Slug lookup error:', merchantError);
                
                // Show friendly error page
                document.body.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        text-align: center;
                        padding: 24px;
                        background: #fafafa;
                    ">
                        <div style="
                            width: 120px;
                            height: 120px;
                            background: linear-gradient(135deg, #f87171, #dc2626);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 24px;
                        ">
                            <span style="font-size: 60px;"></span>
                        </div>
                        <h1 style="font-size: 28px; font-weight: 800; color: #1f2937; margin-bottom: 12px;">
                            Store Not Found
                        </h1>
                        <p style="font-size: 16px; color: #6b7280; max-width: 400px; line-height: 1.6;">
                            We couldn't find a store at <strong>/${slug}</strong>.<br>
                            Please check the link and try again.
                        </p>
                        <a href="/" style="
                            margin-top: 24px;
                            background: #25d078;
                            color: white;
                            padding: 14px 32px;
                            border-radius: 50px;
                            text-decoration: none;
                            font-weight: 700;
                            display: inline-block;
                        ">Go Home</a>
                    </div>
                `;
                return;
            }
            
            // Merchant found! Load their storefront
            console.log(' Found merchant:', merchant.business_name);
            await loadCustomerStorefrontData(merchant);
            
        } catch (error) {
            console.error(' Slug lookup failed:', error);
            alert('Error loading store. Please try again.');
        }
    }

    // LEGACY: Load by merchant ID (kept for backward compatibility)
    async function loadCustomerStorefront(merchantId) {
        console.log(' Loading storefront for merchant ID:', merchantId);
        
        try {
            const { data: merchant, error: merchantError } = await sb
                .from('profiles')
                .select('id, business_name, whatsapp_number, phone_number')
                .eq('id', merchantId)
                .single();
            
            if (merchantError || !merchant) {
                throw new Error('Store not found');
            }
            
            await loadCustomerStorefrontData(merchant);
            
        } catch (error) {
            console.error(' Merchant lookup error:', error);
            alert('Store not found. Please check the link.');
        }
    }

    // SHARED: Load storefront data (used by both slug and ID lookups)
    async function loadCustomerStorefrontData(merchant) {
        // Store merchant data for WhatsApp contact
        CURRENT_MERCHANT_DATA = merchant;
        
        const businessName = merchant.business_name || 'My Store';
        
        // Update store name elements
        const storeNameEl = document.getElementById('customer-store-name');
        const heroStoreNameEl = document.getElementById('customer-hero-store-name');
        
        if (storeNameEl) storeNameEl.innerText = businessName;
        if (heroStoreNameEl) heroStoreNameEl.innerText = businessName;
        
        // Start typewriter animation
        typeWriterCustomer("Welcome to our store, you are our priority ");
        
        // Start Hero Carousel
        const slides = document.querySelectorAll('.hero-slide');
        if (slides.length > 1) {
            let currentSlide = 0;
            slides[0]?.classList.add('active');
            setInterval(() => {
                slides[currentSlide]?.classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;
                slides[currentSlide]?.classList.add('active');
            }, 5000);
        }

        // Fetch products
        const { data: products, error: productsError } = await sb
            .from('products')
            .select(`
                id,
                name,
                description,
                selling_price,
                total_stock,
                image_path,
                product_images(image_url)
            `)
            .eq('merchant_id', merchant.id)
            .gt('total_stock', 0);
        
        if (productsError) {
            console.error('Products error:', productsError);
            throw new Error(`Products fetch failed: ${productsError.message}`);
        }
        
        // Filter active products
        const activeProducts = products?.filter(p => p.is_active !== false) || [];
        
        // Render products
        const container = document.getElementById('customer-products-grid');
        if (!container) throw new Error('Products container not found');
        
        container.innerHTML = '';
        
        if (activeProducts.length > 0) {
            activeProducts.forEach((p, index) => {
                const img = getProductImage(p);
                const safeName = (p.name || 'Product').replace(/'/g, "\\'");
                const safeDesc = (p.description || '').replace(/'/g, "\\'");
                
                const html = `
                <div class="customer-product-card" 
                     onclick="openProductDetailPage('${p.id}', '${safeName}', '${p.selling_price}', '${p.total_stock}', '${img}', '${safeDesc}')" 
                     style="animation-delay: ${index * 0.1}s">
                    <div class="modern-img-wrapper">
                        <img src="${img}" class="modern-img" alt="${safeName}">
                    </div>
                    <div class="modern-details" style="padding: 16px;">
                        <h4 class="modern-title">${p.name}</h4>
                        <p class="modern-price">Tsh ${p.selling_price.toLocaleString()}</p>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        } else {
            container.innerHTML = `
                <div style="grid-column: 1/-1; padding:80px 20px; text-align:center; color:#94a3b8;">
                    <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                        <span class="material-symbols-outlined" style="font-size:48px; color:#667eea;">inventory_2</span>
                    </div>
                    <p style="font-size:18px; font-weight:700; color:#64748b; margin-bottom: 8px;">No Products Available</p>
                    <p style="font-size:14px; color:#94a3b8;">Please check back later</p>
                </div>`;
        }
        
        // Show storefront
        showScreen('customer-storefront', true);
        
        // Track visit
        if (window.amp) {
            amp.logEvent("Customer Storefront Visited", {
                merchant_id: merchant.id,
                merchant_name: businessName,
                products_count: activeProducts.length
            });
        }
    }

    function contactMerchantWhatsApp() {
        if (!CURRENT_MERCHANT_DATA) {
            alert('Contact information not available');
            return;
        }
        
        const phone = CURRENT_MERCHANT_DATA.whatsapp_number || CURRENT_MERCHANT_DATA.phone_number;
        
        if (!phone) {
            alert('WhatsApp number not available. Please contact the merchant directly.');
            return;
        }
        
        const message = `Hi! I'm interested in your products. Can you help me?`;
        const whatsappUrl = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
        
        // Track contact attempt
        if (window.amp) {
            amp.logEvent("Customer Contact Merchant", {
                merchant_name: CURRENT_MERCHANT_DATA.business_name
            });
        }
    }

    // NEW: Typewriter function for customer welcome message
    function typeWriterCustomer(text) {
        const element = document.getElementById('customer-typewriter');
        if (!element) return;
        
        let i = 0;
        element.textContent = "";
        
        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(type, 80); // Typing speed
            }
        }
        
        // Start typing after a brief delay
        setTimeout(type, 500);
    }

    // NEW: Smooth scroll to products section
    function scrollToProducts() {
        const productsSection = document.getElementById('customer-products-section');
        if (productsSection) {
            productsSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    }
</script>

<style>
/* Typewriter Cursor Animation */
.cursor {
    display: inline-block;
    animation: blink 1s infinite;
    margin-left: 2px;
    font-weight: 400;
}

@keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
}

/* Smooth scroll for chat */
#ai-chat-stream {
    scroll-behavior: smooth;
}

/* UPDATED: Clean AI Response Bubble */
.chat-bubble.ai-response {
    background-color: white !important;
    color: #0f1a14 !important;
    border: 1px solid #e5e7eb !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
}

/* Keep user bubble white */
.chat-bubble.user {
    background-color: #f3f4f6 !important;
    color: #0f1a14 !important;
    border: 1px solid #e5e7eb !important;
}

/* AI bubble - green background */
.chat-bubble.ai {
    background-color: #25d078 !important;
    color: white !important;
}
</style>

</body>
</html>